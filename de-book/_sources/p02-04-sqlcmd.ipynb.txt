{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# SQLCMD\n",
    "\n",
    "- Bật SQLCMD Mode: `SQL Script >> Query >> SQLCMD Mode`\n",
    "\n",
    "- Bật SQLCMD Mode default: Tools >> Options >> Query Execution >> SQLCMD Mode\n",
    "\n",
    "**Chạy script từ script**\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```sql\n",
    ":setvar path \"F:\\OneDrive - VPBank\\1. Personal projects\\SQL in R\\sqlcmd example\"\n",
    "\n",
    ":r $(path)\"\\test\\test_1.sql\"\n",
    "\n",
    "```"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "- Chạy SQL từ bat\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```cmd\n",
    "sqlcmd -S computer-name -U sa -P 123 -i master.sql -o out.log\n",
    "```"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "- Đặt job với SQLCMD option\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```sql\n",
    "sqlcmd -i \"F:/sqlcmd example/master.sql\"\n",
    "```"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "![](Images/job_sqlcmd.png)\n",
    "\n",
    "\n",
    "## SQLCMD là gì?\n",
    "\n",
    "## CMD\n",
    "\n",
    "CMD (Command Prompt) là một ứng dụng dùng để thực thi các lệnh có sẵn trong Windows. Những lệnh này được sử dụng trên một giao diện nhập lệnh thay vì thao tác trực tiếp trên giao diện Windows.\n",
    "\n",
    "![GIAO DIỆN CMD](Images/cmd.png)\n",
    "\n",
    "## SQLCMD\n",
    "\n",
    "SQLCMD là một công cụ đi kèm với SQL Server, cho phép ta thực hiện :\n",
    "  \n",
    "  - Các câu lệnh truy vấn\n",
    "\n",
    "- Stored Procedure\n",
    "\n",
    "- Chạy các file SQL Script có sẵn \n",
    "\n",
    "bằng cách sử dụng các dòng lệnh của ứng dụng CMD.\n",
    "\n",
    "**Khởi động SQLCMD trong SQL Server :**\n",
    "  \n",
    "  ![](Images/sqlcmd.png)\n",
    "\n",
    "Các bước :\n",
    "  \n",
    "  - Query\n",
    "\n",
    "- SQLCMD Mode\n",
    "\n",
    "**Sự khác nhau giữa trước và sau khi khởi động SQLCMD trong SQL Server :**\n",
    "  \n",
    "  ![](Images/sqlcmd1.png)\n",
    "\n",
    "Các dòng lệnh SQLCMD sẽ được bôi nền xám\n",
    "\n",
    "## Các lệnh trong SQLCMD\n",
    "\n",
    "### Các lệnh trên nền SQLQuery\n",
    "\n",
    "#### :r\n",
    "\n",
    "**:r** <*filename*>\n",
    "  \n",
    "  Mục đích : chạy các file SQL scrip có sẵn\n",
    "\n",
    "Ví dụ :\n",
    "  \n",
    "  ![](Images/1_r.png)\n",
    "\n",
    "Lưu ý :\n",
    "  \n",
    "  - Các bảng tạm ở mỗi SQL scrip sẽ được giữ lại trong suốt quá trình chạy các SQL scrip\n",
    "\n",
    "![](Images/1_r2.png)\n",
    "\n",
    "\n",
    "#### :setvar\n",
    "\n",
    "Gồm 2 bước :\n",
    "  \n",
    "  - Tạo biến **:setvar**  <*varname*>  <*\"value\"*>\n",
    "  \n",
    "  - Gọi biến **:r $**(<*varname*>)\n",
    "\n",
    "Mục đích : \n",
    "  \n",
    "  Ví dụ :\n",
    "  \n",
    "  ![](Images/2_setvar.png)\n",
    "\n",
    "\n",
    "#### :connect\n",
    "\n",
    "**:connect** <*server_name*> <*[-l timeout]*> <*[-U user_name -P password]*>\n",
    "  \n",
    "Trong đó :\n",
    "  \n",
    "- server_name : tên server muốn truy cập\n",
    "\n",
    "- l : thời gian để kết nối với server, tính theo (giây), thời gian mặc định : 8s\n",
    "\n",
    "- U : user name\n",
    "\n",
    "- P : password\n",
    "\n",
    "Mục đích : với những câu lệnh nặng phải query toàn bộ trên 1 server khác, nên đăng nhập server đó để query vào 1 bảng tạm --> sau đó kéo về server của mình.\n",
    "\n",
    "Ví dụ :\n",
    "  \n",
    "  ![](Images/3_connect1.png)\n",
    "\n",
    "Lưu ý :\n",
    "  \n",
    "  - Bảng tạm trên server khác cần kéo về có dạng **##**\n",
    "  \n",
    "  - Khi chuyển data về server của mình, không được đóng tab chứa query của bảng tạm\n",
    "\n",
    "\n",
    "### Các lệnh trên CmdExec\n",
    "\n",
    "#### Các bước đặt job sử dụng CmdExec\n",
    "\n",
    "![](Images/4_job1.png)\n",
    "\n",
    "![](Images/4_job2.png)\n",
    "\n",
    "- B0: Thực hiện đặt job như thông thường tới bước tạo các Step\n",
    "\n",
    "- B1: Chọn Type : Operating system (CmdExec)\n",
    "\n",
    "- B2: chọn Run as : SQL Server Agent service Account\n",
    "\n",
    "- B3: Viết câu lệnh sqlcmd\n",
    "\n",
    "\n",
    "#### Các lệnh trên CmdExec\n",
    "\n",
    "Cấu trúc\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "```sql\n",
    "sqlcmd <[-S server_name]> <[-l timeout]> <[-U user -P password]> <[-d database_name]> <-i \"input_file\"> <\"file\"> <[-t query_timeout]> <[-o output_file]>\n",
    "\n",
    "\n",
    "```"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Trong đó:\n",
    "\n",
    "`-S` server name (default : server hiện tại của máy)\n",
    "\n",
    "`-l` login timeout (default = 8s)\n",
    "\n",
    "`-U` user login \n",
    "\n",
    "`-P` password login (-U và -P là 1 cặp đi cùng nhau)\n",
    "\n",
    "`-d` use database name (default = master)\n",
    "\n",
    "`-i` input file (nếu đường dẫn có khoảng trống thì cần đặt trong \"\")\n",
    "\n",
    "`-t` query timeout (default = n, nếu gán giá trị thì trong khoảng 1 - 65534s)\n",
    "\n",
    "`-o` output file, được xuất ra thư mục chứa **input file**, gồm các định dạng: .log, .doc, .xls\n",
    "\n",
    "Ví dụ :\n",
    "  \n",
    "![](Images/4_job3.png)\n",
    "\n",
    "Tìm hiểu thêm về các lệnh : Trên màn hình cmd, nhập lệnh **sqlcmd -?**\n",
    "  \n",
    "![](Images/4_bonus.png)\n",
    "\n",
    "## Tạo file bat\n",
    "\n",
    "Mục đích : Có thể nhanh chóng query câu lệnh và xuất dữ liệu\n",
    "\n",
    "Các bước :\n",
    "  \n",
    "- Bước 1: Tạo 1 file Text\n",
    "\n",
    "![](Images/5_bat1.png)\n",
    "\n",
    "- Bước 2 : Copy toàn bộ câu lệnh trong CmdExec vào file Text\n",
    "\n",
    "![](Images/5_bat2.png)\n",
    "\n",
    "- Bước 3 : Save as file --> thêm đuôi **.bat** vào tên file\n",
    "\n",
    "![](Images/5_bat3.png)\n",
    "\n",
    "- Bước 4: Double click vào file .bat vừa tạo để chạy câu lệnh\n",
    "\n",
    "![](Images/5_bat4.png)\n"
   ]
  }
 ],
 "metadata": {
  "anaconda-cloud": "",
  "kernelspec": {
   "display_name": "R",
   "langauge": "R",
   "name": "ir"
  },
  "language_info": {
   "codemirror_mode": "r",
   "file_extension": ".r",
   "mimetype": "text/x-r-source",
   "name": "R",
   "pygments_lexer": "r",
   "version": "3.4.1"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 1
}
