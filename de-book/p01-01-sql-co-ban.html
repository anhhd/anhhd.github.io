

<!DOCTYPE html>
<html class="writer-html5" lang="vi" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>1. Giới thiệu về SQL &mdash; Tài liệu Khai thác dữ liệu với SQL 2019</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=33847982"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="_static/copybutton.js?v=f281be69"></script>
      <script src="_static/translations.js?v=4c1d55b0"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Tìm Kiếm" href="search.html" />
    <link rel="next" title="11. Mẹo với SQL" href="p01-02-tricks-sql.html" />
    <link rel="prev" title="SQL cơ bản" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Khai thác dữ liệu với SQL
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">SQL cơ bản</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">1. Giới thiệu về SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Các-nhóm-câu-lệnh-truy-vấn,-tổng-hợp">2. Các nhóm câu lệnh truy vấn, tổng hợp</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Cách-viêt-comment">2.1. Cách viêt comment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Khái-quát-các-câu-lệnh-truy-vấn-trong-SQL">2.2. Khái quát các câu lệnh truy vấn trong SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Hàm-SELECT">2.3. Hàm SELECT</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Câu-lệnh-where">2.4. Câu lệnh where</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Xử-lý-null">2.5. Xử lý null</a></li>
<li class="toctree-l2"><a class="reference internal" href="#CASE-WHEN">2.6. CASE WHEN</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Having">2.7. Having</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Union">2.8. Union</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Window-function">2.9. Window function</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Các-nhóm-câu-lệnh-tính-toán">2.10. Các nhóm câu lệnh tính toán</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Join-các-bảng">2.11. Join các bảng</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Làm-việc-với-string">2.12. Làm việc với string</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Làm-việc-với-date">2.13. Làm việc với date</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Datediff">2.13.1. Datediff</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Dateadd">2.13.2. Dateadd</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Tricks-với-dữ-liệu-thời-gian">2.13.3. Tricks với dữ liệu thời gian</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#Các-nhóm-câu-lệnh-thay-đổi-dữ-liệu-trong-CSDL">3. Các nhóm câu lệnh thay đổi dữ liệu trong CSDL</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Tạo-bảng-mới">3.1. Tạo bảng mới</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Xóa-bảng-Drop-Table">3.2. Xóa bảng Drop Table</a></li>
<li class="toctree-l2"><a class="reference internal" href="#INSERT-INTO">3.3. INSERT INTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Update">3.4. Update</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Delete-from">3.5. Delete from</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Alter-table">3.6. Alter table</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Đổi-tên-bảng,-tên-cột">3.7. Đổi tên bảng, tên cột</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Truncate">3.8. Truncate</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ALTER---Thay-đổi-định-dạng-dữ-liệu-của-cột">3.9. ALTER - Thay đổi định dạng dữ liệu của cột</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#Sub-Query">4. Sub Query</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Sub-Query-cơ-bản">4.1. Sub Query cơ bản</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Sử-dụng-WITH-thay-thế-subquery">4.2. Sử dụng WITH thay thế subquery</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#Các-nhóm-câu-lệnh-cơ-bản-khác">5. Các nhóm câu lệnh cơ bản khác</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Exists">5.1. Exists</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Any-vs.-All">5.2. Any vs. All</a></li>
<li class="toctree-l2"><a class="reference internal" href="#View">5.3. View</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Index">5.4. Index</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Bảng-tạm">5.5. Bảng tạm</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Kiểm-tra-kiểu-dữ-liệu-trong-bảng">5.6. Kiểm tra kiểu dữ liệu trong bảng</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#SQL-động-với-Exec">6. SQL động với Exec</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Hàm-và-thủ-tục">7. Hàm và thủ tục</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Procedure">7.1. Procedure</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Hiển-thị-tất-cả-các-procedure-đang-lưu-trong-hệ-thống">7.1.1. Hiển thị tất cả các procedure đang lưu trong hệ thống</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Tạo-procedure">7.1.2. Tạo procedure</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Gán-kết-quả-1-procedure-vào-biến">7.1.3. Gán kết quả 1 procedure vào biến</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Hàm-(function)">7.2. Hàm (function)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#Các-nhóm-câu-lệnh-nâng-cao">8. Các nhóm câu lệnh nâng cao</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#If...Else">8.1. If…Else</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Check-điều-kiện-để-thực-thi-tiếp">8.2. Check điều kiện để thực thi tiếp</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Vòng-lặp-với-bảng">8.3. Vòng lặp với bảng</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#Đặt-job-trong-SQL">9. Đặt job trong SQL</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Bước-1:-Active-email-tự-động">9.1. Bước 1: Active email tự động</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Bước-2:-Đăng-kí-email-trong-Database-mail">9.2. Bước 2: Đăng kí email trong Database mail</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Bước-3:-Active-SQL-Server-Agent">9.3. Bước 3: Active SQL Server Agent</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Bước-4:-Đặt-Job">9.4. Bước 4: Đặt Job</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#Các-nhóm-câu-lệnh-quản-trị">10. Các nhóm câu lệnh quản trị</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Tìm-kiếm-các-query-đang-chạy">10.1. Tìm kiếm các query đang chạy</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="p01-02-tricks-sql.html">11. Mẹo với SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-03-sql-tuning.html">12. SQL tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-04-sql-style.html">13. SQL style guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">SQL nâng cao</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p02-03-sql-nang-cao.html">1. Pivot - Unpivot</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-03-sql-nang-cao.html#Chia-một-cột-thành-nhiều-cột">2. Chia một cột thành nhiều cột</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-04-sqlcmd.html">3. SQLCMD</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-05-sql-project.html">4. SQL prọject</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">SQL &amp; Analytics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p03-06-sql-va-excel.html">1. Kết nối SQL với Excel phục vụ báo cáo tự động</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Xây dựng DataMart</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p04-01-dwh.html">1. Data Warehouse Modelling</a></li>
<li class="toctree-l1"><a class="reference internal" href="p04-11-xay-dung-database.html">2. Xây dựng Data warehouse &amp; Data Mart</a></li>
<li class="toctree-l1"><a class="reference internal" href="p04-13-ibm-dwh.html">3. IBM Banking Data Model</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tài liệu tham khảo:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p09-79-tai-lieu-tham-khao.html">Tài liệu tham khảo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Khai thác dữ liệu với SQL</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">1. </span>Giới thiệu về SQL</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/p01-01-sql-co-ban.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Giới-thiệu-về-SQL">
<h1><span class="section-number">1. </span>Giới thiệu về SQL<a class="headerlink" href="#Giới-thiệu-về-SQL" title="Link to this heading"></a></h1>
<p>SQL là viết tắt của <em>Structured Language Query</em>, là một ngôn ngữ truy vấn, xử lý và làm việc với database.</p>
<p>SQL được cấu thành từ 3 nhóm câu lệnh lớn:</p>
<ul class="simple">
<li><p>Data Manipulation Language (DML): Select, Insert, Update, Delete</p></li>
<li><p>Data Definition Language (DDL): Create, Alter, Drop</p></li>
<li><p>Data Control Language (DCL): Grant, Revoke &amp; Deny</p></li>
</ul>
<p>Tuy nhiên, nếu chia theo các câu lệnh để ứng dụng trong phân tích dữ liệu, có 3 nhóm sau.</p>
<ul class="simple">
<li><p>Nhóm câu lệnh truy vấn, tổng hợp dữ liệu: Cho phép truy vấn, tổng hợp dữ liệu nhưng không làm thay đổi dữ liệu đang có trong database. Các nhóm này gồm:</p>
<ul>
<li><p>Nhóm truy vấn: Select, Where, Join</p></li>
<li><p>Nhóm tổng hợp: Yêu cầu cần có hàm tổng hợp dữ liệu (aggregate functions) và nhóm hàm <code class="docutils literal notranslate"><span class="pre">group</span> <span class="pre">by</span></code></p></li>
</ul>
</li>
<li><p>Nhóm câu lệnh làm thay đổi cơ sở dữ liệu: Cho phép thay đổi, điều chỉnh dữ liệu đang có trong database.</p>
<ul>
<li><p>Alter</p></li>
<li><p>Update</p></li>
<li><p>Insert</p></li>
<li><p>Delete</p></li>
</ul>
</li>
<li><p>Các nhóm câu lệnh kiểm tra, phân quyền người dùng: Grant, Revoke, Deny</p></li>
</ul>
<p>Ngoài ra, SQL còn rất mạnh trong việc đặt <code class="docutils literal notranslate"><span class="pre">job</span></code>, xây dựng các câu lệnh tự động với <code class="docutils literal notranslate"><span class="pre">exec</span></code>, xây dựng các hàm (functions) và thủ tục (procedure) trong hệ thống.</p>
<p>Để học và ứng dụng tốt SQL, nên đi theo lộ trình sau.</p>
<ul class="simple">
<li><p>Các nhóm câu lệnh truy vấn: Select, Join, Where, Group By, Pivot, Unpivot,</p></li>
<li><p>Sub Query</p></li>
<li><p>Nhóm câu lệnh biến đồi: Alter, Update, Insert, Delete</p></li>
<li><p>Các nhóm câu lệnh làm việc với chuỗi (string), thời gian (date)</p></li>
<li><p>SQL động</p></li>
<li><p>Vòng lặp</p></li>
<li><p>Đặt job</p></li>
</ul>
<p>Ngoài ra, khi làm việc với các ngôn ngữ phân tích dữ liệu như R hoặc Python, cần nắm vững cách thức truy vấn dữ liệu từ SQL sang các công cụ phân tích.</p>
</section>
<section id="Các-nhóm-câu-lệnh-truy-vấn,-tổng-hợp">
<h1><span class="section-number">2. </span>Các nhóm câu lệnh truy vấn, tổng hợp<a class="headerlink" href="#Các-nhóm-câu-lệnh-truy-vấn,-tổng-hợp" title="Link to this heading"></a></h1>
<section id="Cách-viêt-comment">
<h2><span class="section-number">2.1. </span>Cách viêt comment<a class="headerlink" href="#Cách-viêt-comment" title="Link to this heading"></a></h2>
<p>Sử dụng dấu <code class="docutils literal notranslate"><span class="pre">--</span></code> hoặc trong block <code class="docutils literal notranslate"><span class="pre">/*.....*/</span></code></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">Cách 1: This is</span>
<span class="cm">my block of comment</span>
<span class="cm">*/</span>

<span class="c1">--Cách 2</span>
<span class="c1">--Khó dùng hơn</span>
</pre></div>
</div>
</section>
<section id="Khái-quát-các-câu-lệnh-truy-vấn-trong-SQL">
<h2><span class="section-number">2.2. </span>Khái quát các câu lệnh truy vấn trong SQL<a class="headerlink" href="#Khái-quát-các-câu-lệnh-truy-vấn-trong-SQL" title="Link to this heading"></a></h2>
<p>Các câu lệnh SQL diễn ra theo thứ tự sau:</p>
<p>SELECT &gt;&gt; FROM &gt;&gt; WHERE &gt;&gt; GROUP BY &gt;&gt; HAVING &gt;&gt; ORDER BY</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
<span class="p">[</span><span class="k">DISTINCT</span><span class="p">][</span><span class="n">TOP</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="p">)]</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">columns</span><span class="p">,</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">expressions</span>
<span class="p">[</span><span class="k">FROM</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">source</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span>
<span class="p">[</span><span class="k">JOIN</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">source</span>
<span class="k">ON</span><span class="w"> </span><span class="n">condition</span><span class="p">](</span><span class="n">may</span><span class="w"> </span><span class="n">include</span><span class="w"> </span><span class="n">multiple</span><span class="w"> </span><span class="n">joins</span><span class="p">)</span>
<span class="p">[</span><span class="k">WHERE</span><span class="w"> </span><span class="n">conditions</span><span class="p">]</span>
<span class="p">[</span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">columns</span><span class="p">]</span>
<span class="p">[</span><span class="k">HAVING</span><span class="w"> </span><span class="n">conditions</span><span class="p">]</span>
<span class="p">[</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">Columns</span><span class="p">];</span>
</pre></div>
</div>
</section>
<section id="Hàm-SELECT">
<h2><span class="section-number">2.3. </span>Hàm SELECT<a class="headerlink" href="#Hàm-SELECT" title="Link to this heading"></a></h2>
<p><strong>Lưu ý</strong>: Các bảng thường bắt đầu bằng <strong>.dbo</strong>, gọi là <em>schema</em>. Thông thường, schema này là default. Tuy nhiên, nếu DB admin đổi schema, ta cần phải đổi câu lệnh</p>
<ul class="simple">
<li><p>Lấy tất cả các biến</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">---Cách 1</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">AdventureWorksDW2012</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">DimCustomer</span>

<span class="c1">---Cách 2</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">AdventureWorksDW2012</span><span class="p">..</span><span class="n">DimCustomer</span>

<span class="c1">---Cách 3: Khai báo DB với use</span>
<span class="n">use</span><span class="w"> </span><span class="n">AdventureWorksDW2012</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">DimCustomer</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Lấy top n dòng đầu tiên hoặc n phần trăm đầu tiên</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">learnsql</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">product</span>
<span class="k">select</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="n">percent</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">learnsql</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">product</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Lấy một vài biến</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--Cách 1</span>
<span class="k">select</span><span class="w"> </span><span class="n">Product_CD</span><span class="p">,</span><span class="w"> </span><span class="n">Date_offered</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">learnsql</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">product</span>

<span class="c1">-- Cách 2</span>
<span class="k">select</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">Product_CD</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">Date_offered</span>
<span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">learnsql</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">product</span><span class="w"> </span><span class="n">A</span>

<span class="c1">-- Cách 3: Dùng Aliases</span>
<span class="k">select</span><span class="w"> </span><span class="n">Product_CD</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">[</span><span class="n">Product</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CD</span><span class="p">]</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">learnsql</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">product</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>: Đặt tên bảng là A trong cách thứ 2 giúp ích khi lấy dữ liệu và nhóm các giá trị từ nhiều bảng</p>
<ul class="simple">
<li><p>Ghép kết quả</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--- TH1: Cùng kiểu dữ liệu nvarchar</span>
<span class="k">select</span><span class="w"> </span><span class="n">firstname</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lastname</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">[</span><span class="n">FULL_NAME</span><span class="p">]</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">dimcustomer</span>

<span class="c1">--- TH2: nvarchar với numeric</span>
<span class="c1">--- Dùng cast</span>

<span class="k">select</span><span class="w"> </span><span class="n">lastname</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="n">customerkey</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">[</span><span class="n">Name</span><span class="w"> </span><span class="n">ID</span><span class="p">]</span>
<span class="k">from</span><span class="w"> </span><span class="n">dimcustomer</span>

<span class="c1">--- Dùng convert</span>
<span class="k">select</span><span class="w"> </span><span class="n">lastname</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">convert</span><span class="p">(</span><span class="n">nvarchar</span><span class="p">,</span><span class="w"> </span><span class="n">customerkey</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">[</span><span class="n">Name</span><span class="w"> </span><span class="n">ID</span><span class="p">]</span>
<span class="k">from</span><span class="w"> </span><span class="n">DimCustomer</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Lấy các giá trị không trùng lặp: dùng hàm distinct</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">Pro</span><span class="p">.</span><span class="n">Product_Type_Cd</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">Product</span><span class="w"> </span><span class="n">Pro</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="Câu-lệnh-where">
<h2><span class="section-number">2.4. </span>Câu lệnh where<a class="headerlink" href="#Câu-lệnh-where" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><strong>Where</strong>: Tìm điều kiện theo dòng</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">Select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">From</span>
<span class="w">      </span><span class="n">learnsql</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">Product</span><span class="w"> </span><span class="n">Pro</span>
<span class="w">      </span><span class="k">Where</span><span class="w"> </span><span class="n">Pro</span><span class="p">.</span><span class="n">Product_Type_Cd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;LOAN&#39;</span>

<span class="c1">--- Dấu khác</span>
<span class="k">Select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">From</span>
<span class="w">      </span><span class="n">learnsql</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">Product</span><span class="w"> </span><span class="n">Pro</span>
<span class="w">      </span><span class="k">Where</span><span class="w"> </span><span class="n">Pro</span><span class="p">.</span><span class="n">Product_Type_Cd</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s1">&#39;LOAN&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>IN</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--Lựa chọn nhiều điều kiện</span>
<span class="k">Select</span><span class="w"> </span><span class="n">Emp</span><span class="p">.</span><span class="n">Emp_Id</span>
<span class="w">     </span><span class="p">,</span><span class="n">Emp</span><span class="p">.</span><span class="n">First_Name</span>
<span class="w">     </span><span class="p">,</span><span class="n">Emp</span><span class="p">.</span><span class="n">Last_Name</span>
<span class="w">     </span><span class="p">,</span><span class="n">Emp</span><span class="p">.</span><span class="n">Dept_Id</span>
<span class="w">    </span><span class="k">From</span><span class="w">  </span><span class="n">learnsql</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">Employee</span><span class="w"> </span><span class="n">Emp</span>
<span class="w">    </span><span class="k">Where</span><span class="w">  </span><span class="n">Emp</span><span class="p">.</span><span class="n">First_Name</span><span class="w"> </span><span class="k">In</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Susan&#39;</span><span class="p">,</span><span class="s1">&#39;Paula&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">OR</span>
<span class="w">           </span><span class="p">(</span><span class="n">Emp</span><span class="p">.</span><span class="n">Last_Name</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">In</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Fleming&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Roberts&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AND</span>
<span class="w">           </span><span class="n">Emp</span><span class="p">.</span><span class="n">Emp_Id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;6&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>: Toán tử IN trong SQL tương tự như %in% trong R</p>
<ul class="simple">
<li><p>Kết hợp toán tử AND, OR</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">Select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">From</span>
<span class="w">      </span><span class="n">learnsql</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">Product</span><span class="w"> </span><span class="n">Pro</span>
<span class="w">      </span><span class="k">Where</span><span class="w"> </span><span class="p">(</span><span class="n">Pro</span><span class="p">.</span><span class="n">Product_Type_Cd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;LOAN&#39;</span><span class="w"> </span><span class="k">AND</span>
<span class="w">      </span><span class="n">Pro</span><span class="p">.</span><span class="n">Product_CD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;AUT&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">OR</span>
<span class="w">      </span><span class="p">(</span><span class="n">Pro</span><span class="p">.</span><span class="n">NAME</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%dep%&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Truy vấn đồng thời tính toán trong SQL</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--Lưu ý: Để phép toán cần tính trong dấu ngoặc đơn</span>
<span class="c1">--DUC_ANH là tên biến mới sau khi biến đổi</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">[</span><span class="n">BUSINESS_DATE</span><span class="p">]</span>
<span class="w">      </span><span class="p">,[</span><span class="n">ACNT_CONTRACT_ID</span><span class="p">]</span>
<span class="w">      </span><span class="p">,[</span><span class="n">CARD_STATUS</span><span class="p">]</span>
<span class="w">      </span><span class="p">,([</span><span class="n">CARD_LIMIT</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10000</span><span class="p">)</span><span class="o">/</span><span class="mi">30</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">DUC_ANH</span>
<span class="w">      </span><span class="p">,[</span><span class="n">BALANCE</span><span class="p">]</span>
<span class="w">      </span><span class="p">,[</span><span class="n">T24_CIF</span><span class="p">]</span>
<span class="w">      </span><span class="p">,[</span><span class="n">CUSTOMER_NAME</span><span class="p">]</span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">SERVER74</span><span class="p">].[</span><span class="n">BICDATA</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">CARD_HIS</span><span class="p">]</span>
<span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%ANH&#39;</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>:</p>
<ul class="simple">
<li><p>Để phân biệt tên của các cột trong bảng với các điều kiện có thể bị trùng. VD: Tên bảng là <strong>OR</strong> dễ bị trùng với điều kiện OR, ta đặt tên bảng, tên DB trong dấu ngoặc vuông</p></li>
<li><p>Các phép toán thường gặp =,&lt;, &gt;, &gt;=, &lt;=, IN, &lt;&gt;, is not null</p></li>
<li><p>Các toán tử với <strong>Wild Card</strong>: LIKE, NOT LIKE</p>
<ul>
<li><p>Ký tự <strong>%ANH</strong>: tìm các character bắt đầu bằng bất cứ thứ gì nhưng sau đó đi kèm chuỗi ký tự ANH</p></li>
<li><p>Ký tự **_** (underscore): tìm các ký tự đơn.</p></li>
</ul>
</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">[</span><span class="n">BUSINESS_DATE</span><span class="p">]</span>
<span class="w">      </span><span class="p">,[</span><span class="n">CUSTOMER_NAME</span><span class="p">]</span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">SERVER74</span><span class="p">].[</span><span class="n">BICDATA</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">CARD_HIS</span><span class="p">]</span>
<span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%ANH&#39;</span><span class="w"> </span><span class="k">OR</span>
<span class="w">  </span><span class="n">customer_name</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;A_H&#39;</span><span class="w"> </span><span class="k">and</span>
<span class="w">  </span><span class="n">card_status</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
</pre></div>
</div>
</section>
<section id="Xử-lý-null">
<h2><span class="section-number">2.5. </span>Xử lý null<a class="headerlink" href="#Xử-lý-null" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Khi ghép 2 string, 1 string là NULL, SQL sẽ trả ra kết quả NULL (không như R, tự động loại NA)</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--- Dữ liệu gốc</span>
<span class="k">select</span><span class="w"> </span><span class="n">firstname</span><span class="p">,</span><span class="w"> </span><span class="n">middlename</span><span class="p">,</span><span class="w"> </span><span class="n">lastname</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">DimCustomer</span>

<span class="c1">--- Giá trị NULL</span>
<span class="k">select</span><span class="w"> </span><span class="n">firstname</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">middlename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lastname</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">[</span><span class="k">Full</span><span class="w"> </span><span class="n">Name</span><span class="p">]</span>
<span class="k">from</span><span class="w"> </span><span class="n">dimcustomer</span>

<span class="c1">--- Xử lý cách 1: Dùng ISNULL</span>
<span class="k">select</span><span class="w"> </span><span class="n">firstname</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">isnull</span><span class="p">(</span><span class="n">middlename</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lastname</span>
<span class="k">as</span><span class="w"> </span><span class="p">[</span><span class="k">Full</span><span class="w"> </span><span class="n">Name</span><span class="p">]</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">dimcustomer</span>

<span class="c1">--- Xử lý cách 2: Dùng CASE WHEN</span>
<span class="k">select</span><span class="w"> </span><span class="n">firstname</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">+</span>
<span class="k">case</span>
<span class="k">when</span><span class="w"> </span><span class="n">middlename</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="k">else</span><span class="w"> </span><span class="n">middlename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; &#39;</span>
<span class="k">end</span>
<span class="o">+</span><span class="w"> </span><span class="n">lastname</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">[</span><span class="k">Full</span><span class="w"> </span><span class="n">Name</span><span class="p">]</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">dimcustomer</span>

<span class="c1">-- Xử lý cách 3: Dùng Coalesce</span>
<span class="k">select</span><span class="w"> </span><span class="k">coalesce</span><span class="p">(</span><span class="n">firstname</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">middlename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">+</span><span class="n">lastname</span><span class="p">,</span>
<span class="n">firstname</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">+</span><span class="n">lastname</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">[</span><span class="k">Full</span><span class="w"> </span><span class="n">Name</span><span class="p">]</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">dimcustomer</span>
</pre></div>
</div>
</section>
<section id="CASE-WHEN">
<h2><span class="section-number">2.6. </span>CASE WHEN<a class="headerlink" href="#CASE-WHEN" title="Link to this heading"></a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">AVAIL_BALANCE</span><span class="p">,</span>
<span class="p">(</span><span class="k">CASE</span><span class="w">  </span><span class="k">when</span><span class="w"> </span><span class="n">AVAIL_BALANCE</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5000</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">N</span><span class="s1">&#39;small&#39;</span>
<span class="w">      </span><span class="k">when</span><span class="w"> </span><span class="n">AVAIL_BALANCE</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">5000</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">AVAIL_BALANCE</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">N</span><span class="s1">&#39;medium&#39;</span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="n">N</span><span class="s1">&#39;high&#39;</span>
<span class="w">      </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">category</span>
<span class="k">from</span><span class="w"> </span><span class="n">account</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>:</p>
<ul class="simple">
<li><p>N trong câu lệnh trên viết tắt của NVARCHAR để khai báo dạng lệnh</p></li>
</ul>
</section>
<section id="Having">
<h2><span class="section-number">2.7. </span>Having<a class="headerlink" href="#Having" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><strong>Having</strong>: Tìm điều kiện sau khi có kết quả. Lưu ý: Câu lệnh Having không hoạt động với ALIAS, phải hiển thị điều kiện từ bảng gốc</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
<span class="w"> </span><span class="n">OPEN_BRANCH_ID</span>
<span class="p">,</span><span class="k">sum</span><span class="p">(</span><span class="n">AVAIL_BALANCE</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">new</span>
<span class="k">from</span><span class="w"> </span><span class="n">account</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">OPEN_BRANCH_ID</span>
<span class="k">having</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">AVAIL_BALANCE</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">500000</span>

<span class="c1">-- Câu lệnh sau sẽ không chạy với where</span>

<span class="k">select</span>
<span class="w"> </span><span class="n">OPEN_BRANCH_ID</span>
<span class="p">,</span><span class="k">sum</span><span class="p">(</span><span class="n">AVAIL_BALANCE</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">new</span>
<span class="k">where</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">AVAIL_BALANCE</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">500000</span>
<span class="k">from</span><span class="w"> </span><span class="n">account</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">OPEN_BRANCH_ID</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>: Ký tự trong SQL cần đặt trong 1 dấu nháy đơn ''</p>
<ul class="simple">
<li><p>Có thể sử dụng các phép toán đơn giản trong WHERE</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">ACCOUNT</span>
<span class="k">where</span><span class="w"> </span><span class="n">AVAIL_BALANCE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">6000</span>
</pre></div>
</div>
</section>
<section id="Union">
<h2><span class="section-number">2.8. </span>Union<a class="headerlink" href="#Union" title="Link to this heading"></a></h2>
<p>Nhóm câu lệnh Union có 2 câu lệnh chính:</p>
<ul class="simple">
<li><p>UNION: Loại bỏ các giá trị trùng của các dòng</p></li>
<li><p>UNION ALL: Hiển thị tất cả các giá trị</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="mi">10</span>
<span class="p">[</span><span class="n">CUSTOMER_NAME</span><span class="p">]</span>
<span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">SERVER74</span><span class="p">].[</span><span class="n">BICDATA</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">CARD_HIS</span><span class="p">]</span>
<span class="k">where</span><span class="w"> </span><span class="p">[</span><span class="n">CUSTOMER_NAME</span><span class="p">]</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%HƯƠNG&#39;</span><span class="p">)</span>
<span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="mi">10</span>
<span class="p">[</span><span class="n">CUSTOMER_NAME</span><span class="p">]</span>
<span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">SERVER74</span><span class="p">].[</span><span class="n">BICDATA</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">BALANCE_HIS</span><span class="p">]</span>
<span class="k">where</span><span class="w"> </span><span class="p">[</span><span class="n">CUSTOMER_NAME</span><span class="p">]</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%HƯƠNG&#39;</span>
</pre></div>
</div>
</section>
<section id="Window-function">
<h2><span class="section-number">2.9. </span>Window function<a class="headerlink" href="#Window-function" title="Link to this heading"></a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">CUST_ID</span><span class="p">,</span>
<span class="w">        </span><span class="n">AVAIL_BALANCE</span><span class="p">,</span>
<span class="w">        </span><span class="n">ROW_NUMBER</span><span class="p">()</span><span class="w"> </span><span class="n">over</span><span class="p">(</span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">cust_id</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">AVAIL_BALANCE</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">[</span><span class="k">ORDER</span><span class="p">],</span>
<span class="w">        </span><span class="k">avg</span><span class="p">(</span><span class="n">AVAIL_BALANCE</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="p">(</span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">cust_id</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">AVG_BALANCE_ID</span>
<span class="k">from</span><span class="w"> </span><span class="n">ACCOUNT</span>
</pre></div>
</div>
<p><strong>Giải thich</strong>:</p>
<ul class="simple">
<li><p>Nhóm cust_id</p></li>
<li><p>Tính giá trị trung bình, row_number, trả ra kết quả</p></li>
<li><p>Hàm <code class="docutils literal notranslate"><span class="pre">OVER</span> <span class="pre">PARTITION</span> <span class="pre">BY</span></code> ứng với <code class="docutils literal notranslate"><span class="pre">group_by</span> <span class="pre">%&gt;%</span> <span class="pre">mutate</span></code> trong R</p></li>
</ul>
<p><strong>Ứng dụng nâng cao</strong>: Ngoài ra, window function có thể partition theo dòng</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Trường hợp 1: Mặc định</span>
<span class="k">select</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">cusid</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">start_t</span>
<span class="w">          </span><span class="k">rows</span><span class="w"> </span><span class="n">unbounded</span><span class="w"> </span><span class="n">preceding</span><span class="p">)</span><span class="w"> </span><span class="c1">-- Tìm max start_time đến dòng hiện tại theo cusid</span>
<span class="c1">-- Trường hợp 2: Nâng cao</span>
<span class="k">select</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">cusid</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">start_t</span>
<span class="w">          </span><span class="k">rows</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">unbounded</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">preceding</span><span class="p">)</span><span class="w"> </span><span class="c1">-- Tìm max start_time đến dòng phía trên dòng hiện tại theo cusid</span>
</pre></div>
</div>
<p><strong>Ứng dụng</strong>: Khách hàng đi grab không cho phép booking khi chưa hết chuyến. Grab thí điểm sử dụng multiple booking. Xác định các chuyến nào là multiple booking</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="n">gap</span>
<span class="k">GO</span>

<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">gap</span>
<span class="p">(</span><span class="n">cusid</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="n">booking_id</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="n">start_time</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="n">end_time</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span>


<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">gap</span><span class="w"> </span><span class="p">(</span><span class="n">cusid</span><span class="p">,</span><span class="w"> </span><span class="n">booking_id</span><span class="p">,</span><span class="w"> </span><span class="n">start_time</span><span class="p">,</span><span class="w"> </span><span class="n">end_time</span><span class="p">)</span>
<span class="k">values</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">),</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">),</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">),</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">),</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">)</span>


<span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="o">#</span><span class="n">final_results</span><span class="p">,</span><span class="w"> </span><span class="o">#</span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="o">#</span><span class="n">t2</span>

<span class="k">SELECT</span><span class="w">  </span><span class="o">*</span><span class="p">,</span>
<span class="w">    </span><span class="k">MAX</span><span class="p">(</span><span class="n">end_time</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">cusid</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">start_time</span><span class="p">,</span><span class="w"> </span><span class="n">end_time</span>
<span class="w">    </span><span class="k">ROWS</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="n">UNBOUNDED</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">PRECEDING</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">prev_end</span>
<span class="k">into</span><span class="w"> </span><span class="o">#</span><span class="n">t1</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">GAP</span>


<span class="k">select</span>
<span class="w">    </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">is_start</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="p">(</span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">cusid</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">start_time</span><span class="p">,</span><span class="w"> </span><span class="n">end_time</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">[</span><span class="k">group</span><span class="p">]</span>
<span class="k">into</span><span class="w"> </span><span class="o">#</span><span class="n">t2</span>
<span class="k">from</span>
<span class="w">    </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="p">,</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">Start_time</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">prev_end</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">is_start</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="o">#</span><span class="n">t1</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">;</span>

<span class="k">with</span><span class="w"> </span><span class="n">T3</span><span class="w"> </span><span class="k">AS</span>
<span class="w">    </span><span class="p">(</span><span class="k">selecT</span><span class="w"> </span><span class="n">CUSID</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="k">group</span><span class="p">]</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="o">#</span><span class="n">t2</span><span class="w"> </span><span class="n">A</span>
<span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">Cusid</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="k">group</span><span class="p">]</span>
<span class="w">    </span><span class="k">HAVING</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="p">)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">#</span><span class="n">t2</span><span class="p">.</span><span class="o">*</span><span class="w"> </span><span class="p">,</span>
<span class="w">    </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">T3</span><span class="p">.[</span><span class="k">group</span><span class="p">]</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;Multi booking&#39;</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;Single Booking&#39;</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">BOOKING_TYPE</span>
<span class="k">INTO</span><span class="w"> </span><span class="o">#</span><span class="n">final_results</span>
<span class="k">FROM</span><span class="w"> </span><span class="o">#</span><span class="n">t2</span>
<span class="w">    </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">T3</span>
<span class="w">        </span><span class="k">ON</span><span class="w"> </span><span class="o">#</span><span class="n">t2</span><span class="p">.</span><span class="n">CUSID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T3</span><span class="p">.</span><span class="n">CUSID</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">#</span><span class="n">t2</span><span class="p">.[</span><span class="k">group</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T3</span><span class="p">.[</span><span class="k">group</span><span class="p">]</span>

<span class="k">select</span><span class="w"> </span><span class="o">*</span>
<span class="k">from</span><span class="w"> </span><span class="o">#</span><span class="n">final_results</span>
</pre></div>
</div>
</section>
<section id="Các-nhóm-câu-lệnh-tính-toán">
<h2><span class="section-number">2.10. </span>Các nhóm câu lệnh tính toán<a class="headerlink" href="#Các-nhóm-câu-lệnh-tính-toán" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Các phép tính toán cơ bản: COUNT, AGV, MIN, MAX, VARIANCE, STDDEV</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">AMOUNT</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">n</span>
<span class="p">,</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">max</span>
<span class="p">,</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">min</span>
<span class="p">,</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">sum</span>
<span class="p">,</span><span class="w"> </span><span class="n">var</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">var</span>
<span class="p">,</span><span class="w"> </span><span class="n">STDEV</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">std_dev</span>
<span class="k">from</span><span class="w"> </span><span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACC_TRANSACTION</span><span class="p">]</span>
</pre></div>
</div>
<p><strong>Các phép tính hay dùng khác</strong>:</p>
<ul class="simple">
<li><p>FLOOR: Trả số nguyên lớn nhất nhỏ hơn số đã có</p></li>
<li><p>CEILING: trả số nguyên nhỏ nhất lớn hơn số đã có</p></li>
<li><p>ABS: Trả giá trị tuyệt đối</p></li>
<li><p>Các hàm khác: LN, LOG, EXP, POWER</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">CEILING</span><span class="p">(</span><span class="mi">5</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span>
<span class="k">select</span><span class="w"> </span><span class="n">floor</span><span class="p">(</span><span class="mi">5</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span>
<span class="k">select</span><span class="w"> </span><span class="k">abs</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span>
<span class="k">select</span><span class="w"> </span><span class="n">power</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="Join-các-bảng">
<h2><span class="section-number">2.11. </span>Join các bảng<a class="headerlink" href="#Join-các-bảng" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><strong>Trường hợp 1 - Select tất cả các dòng không theo điều kiện</strong>: SQL sẽ nối mỗi dòng ở bảng 1 với mỗi dòng ở bảng 2. Tổng số dòng trong bảng mới sẽ là m*n dòng (m dòng ở bảng 1 và n dòng ở bảng 2)</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--Trường hợp 1: Không có where</span>
<span class="k">select</span>
<span class="n">A</span><span class="p">.</span><span class="n">ACCOUNT_ID</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">AVAIL_BALANCE</span><span class="p">,</span>
<span class="n">B</span><span class="p">.</span><span class="n">ADDRESS</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CITY</span>
<span class="k">from</span>
<span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACCOUNT</span><span class="p">]</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">CUSTOMER</span><span class="p">]</span><span class="w"> </span><span class="n">B</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CITY</span>

<span class="c1">--Trường hợp 2: Sử dụng where</span>
<span class="k">select</span>
<span class="n">A</span><span class="p">.</span><span class="n">ACCOUNT_ID</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">AVAIL_BALANCE</span><span class="p">,</span>
<span class="n">B</span><span class="p">.</span><span class="n">ADDRESS</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CITY</span>
<span class="k">from</span>
<span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACCOUNT</span><span class="p">]</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">CUSTOMER</span><span class="p">]</span><span class="w"> </span><span class="n">B</span>
<span class="k">where</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">ACCOUNT_ID</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CUST_ID</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Woburn&#39;</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">AVAIL_BALANCE</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Trường hợp 2 - Left join, right join</strong>: Các cột từ các bảng khác nhau thì cần phải xác định alias</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
<span class="n">B</span><span class="p">.</span><span class="n">BRANCH_ID</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">ADDRESS</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">CITY</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">NAME</span><span class="p">,</span>
<span class="n">A</span><span class="p">.</span><span class="n">ACCOUNT_ID</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">AVAIL_BALANCE</span>
<span class="k">from</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="n">B</span>
<span class="k">left</span><span class="w"> </span><span class="k">outer</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="n">A</span>
<span class="k">on</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">BRANCH_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">OPEN_BRANCH_ID</span>
<span class="k">where</span><span class="w"> </span><span class="n">BRANCH_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;2&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Lưu ý: Khi câu lệnh bị lỗi Ambiguity, nguyên nhân có thể là do key nối các bảng lại bị trùng với cột khi truy vấn</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">---Trường hợp 1: Không hoạt động</span>
<span class="k">select</span><span class="w"> </span><span class="n">EnglishProductName</span><span class="p">,</span><span class="w"> </span><span class="n">EnglishProductSubcategoryName</span><span class="p">,</span>
<span class="n">ProductSubcategoryKey</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">DimProduct</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span>
<span class="n">DimProductSubcategory</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">S</span>
<span class="k">on</span><span class="w"> </span><span class="n">P</span><span class="p">.</span><span class="n">ProductSubcategoryKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">ProductSubcategoryKey</span>

<span class="c1">---Trường hợp 2: Hoạt động, sau khi đưa alias</span>
<span class="k">select</span><span class="w"> </span><span class="n">EnglishProductName</span><span class="p">,</span><span class="w"> </span><span class="n">EnglishProductSubcategoryName</span><span class="p">,</span>
<span class="n">S</span><span class="p">.</span><span class="n">ProductSubcategoryKey</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">DimProduct</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span>
<span class="n">DimProductSubcategory</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">S</span>
<span class="k">on</span><span class="w"> </span><span class="n">P</span><span class="p">.</span><span class="n">ProductSubcategoryKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">ProductSubcategoryKey</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Trường hợp 3: Inner join</strong></p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">EnglishProductName</span><span class="p">,</span>
<span class="w">  </span><span class="n">EnglishProductSubcategoryName</span>
<span class="w">  </span><span class="p">,</span><span class="n">EnglishProductCategoryName</span>
<span class="k">from</span><span class="w"> </span><span class="n">DimProduct</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span>
<span class="w">  </span><span class="n">DimProductSubcategory</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">S</span>
<span class="w">  </span><span class="k">on</span><span class="w"> </span><span class="n">P</span><span class="p">.</span><span class="n">ProductSubcategoryKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">ProductSubcategoryKey</span>
<span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">DimProductCategory</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">C</span>
<span class="w">  </span><span class="k">on</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">ProductCategoryKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">C</span><span class="p">.</span><span class="n">ProductCategoryKey</span>
<span class="k">where</span><span class="w"> </span><span class="n">EnglishProductName</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%HL%&#39;</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="o">##</span><span class="n">Cus</span>
<span class="k">GO</span>
<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">##</span><span class="n">Cus</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="k">GO</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="o">##</span><span class="n">Cus</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span>
<span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Anh&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;D&#39;</span><span class="p">)</span>

<span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="o">##</span><span class="n">grade</span>
<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">##</span><span class="n">grade</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="n">mon_hoc</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="k">GO</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="o">##</span><span class="n">grade</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">mon_hoc</span><span class="p">)</span>
<span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;toan&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;van&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;toan&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;anh&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;hoa&#39;</span><span class="p">)</span>

<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">##</span><span class="n">Cus</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">##</span><span class="n">grade</span>


<span class="c1">-- Inner Join</span>
<span class="k">select</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="o">*</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="o">*</span>
<span class="k">from</span><span class="w"> </span><span class="o">##</span><span class="n">Cus</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="o">##</span><span class="n">grade</span><span class="w"> </span><span class="n">B</span>
<span class="k">where</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">id</span>

<span class="c1">-- Inner Join (2)</span>
<span class="k">select</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="o">*</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="o">*</span>
<span class="k">from</span><span class="w"> </span><span class="o">##</span><span class="n">Cus</span><span class="w"> </span><span class="n">A</span>
<span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="o">##</span><span class="n">grade</span><span class="w"> </span><span class="n">B</span>
<span class="k">on</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">id</span>

<span class="c1">-- Left Join</span>
<span class="k">select</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="o">*</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="o">*</span>
<span class="k">from</span><span class="w"> </span><span class="o">##</span><span class="n">Cus</span><span class="w"> </span><span class="n">A</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="o">##</span><span class="n">grade</span><span class="w"> </span><span class="n">B</span>
<span class="k">on</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">id</span>

<span class="c1">-- Right Join</span>

<span class="k">select</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="o">*</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="o">*</span>
<span class="k">from</span><span class="w"> </span><span class="o">##</span><span class="n">Cus</span><span class="w"> </span><span class="n">A</span>
<span class="k">right</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="o">##</span><span class="n">grade</span><span class="w"> </span><span class="n">B</span>
<span class="k">on</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">id</span>
</pre></div>
</div>
</section>
<section id="Làm-việc-với-string">
<h2><span class="section-number">2.12. </span>Làm việc với string<a class="headerlink" href="#Làm-việc-với-string" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>CONCAT: Nối các string, tương tự như <strong>paste0</strong> trong R</p></li>
<li><p>LOWER, UPPER: Viết hoa, viết thường các biến</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="mi">10</span>
<span class="w">      </span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>
<span class="w"> </span><span class="p">,[</span><span class="n">BUSINESS_DATE</span><span class="p">]</span>
<span class="w"> </span><span class="p">,</span><span class="k">LOWER</span><span class="p">([</span><span class="n">CUSTOMER_NAME</span><span class="p">])</span>
<span class="w">   </span><span class="p">,</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="n">CUSTOMER_NAME</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ID</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">new_var</span>
<span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">SERVER74</span><span class="p">].[</span><span class="n">BICDATA</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">BALANCE_HIS</span><span class="p">]</span>
<span class="k">where</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
</pre></div>
</div>
<ul class="simple">
<li><p>REPLACE: Thay thế các ký tự trong biến</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="mi">10</span>
<span class="w">     </span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>
<span class="w">  </span><span class="p">,[</span><span class="n">CUSTOMER_NAME</span><span class="p">]</span>
<span class="w">    </span><span class="p">,</span><span class="k">REPLACE</span><span class="p">(</span><span class="n">CUSTOMER_NAME</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;THI&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;***&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">new_name</span>
<span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">SERVER74</span><span class="p">].[</span><span class="n">BICDATA</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">BALANCE_HIS</span><span class="p">]</span>
<span class="k">where</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
</pre></div>
</div>
<ul class="simple">
<li><p>SUBSTRING(var, a, b): Hiển thị b ký tự từ ký tự thứ a của var</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="mi">10</span>
<span class="w">    </span><span class="n">CUSTOMER_NAME</span>
<span class="w">    </span><span class="p">,</span><span class="k">substring</span><span class="p">(</span><span class="n">CUSTOMER_NAME</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">SERVER74</span><span class="p">].[</span><span class="n">BICDATA</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">BALANCE_HIS</span><span class="p">]</span>
<span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
</pre></div>
</div>
</section>
<section id="Làm-việc-với-date">
<h2><span class="section-number">2.13. </span>Làm việc với date<a class="headerlink" href="#Làm-việc-với-date" title="Link to this heading"></a></h2>
<p>Dữ liệu date là dữ liệu rất quan trọng cần nắm vững khi làm việc với dữ liệu. Dữ liệu thời gian có các định dạng thường dùng:</p>
<ul class="simple">
<li><p>101 (mm/dd/yyyy)</p></li>
<li><p>102 (mm/dd/yy)</p></li>
<li><p>103 (dd/mm/yyyy)</p></li>
<li><p>112 (yyyymmdd): Đây là định dạng hay dùng nhất</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Lấy ngày hiện tại</span>

<span class="k">select</span><span class="w"> </span><span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="mi">101</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Date1</span><span class="p">,</span>
<span class="w">       </span><span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="n">BirthDate</span><span class="p">,</span><span class="w"> </span><span class="mi">102</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Date2</span><span class="p">,</span>
<span class="w">       </span><span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="n">birthdate</span><span class="p">,</span><span class="w"> </span><span class="mi">103</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Date3</span>


<span class="k">select</span><span class="w"> </span><span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="n">getdate</span><span class="p">(),</span><span class="mi">101</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Date1</span><span class="p">,</span>
<span class="w">       </span><span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="n">getdate</span><span class="p">(),</span><span class="w"> </span><span class="mi">102</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Date2</span><span class="p">,</span>
<span class="w">       </span><span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="n">getdate</span><span class="p">(),</span><span class="w"> </span><span class="mi">103</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Date3</span><span class="p">,</span>
<span class="w">       </span><span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="n">getdate</span><span class="p">(),</span><span class="w"> </span><span class="mi">112</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Date4</span>
</pre></div>
</div>
<section id="Datediff">
<h3><span class="section-number">2.13.1. </span>Datediff<a class="headerlink" href="#Datediff" title="Link to this heading"></a></h3>
<p>Dùng để tính toán khoảng thời gian giữa hai điểm</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">DATEDIFF</span><span class="p">(</span><span class="nb">interval</span><span class="p">,</span><span class="w"> </span><span class="n">date1</span><span class="p">,</span><span class="w"> </span><span class="n">date2</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">interval</span></code> có các giá trị sau:</p>
<ul class="simple">
<li><p>year, yyyy, yy = Year</p></li>
<li><p>quarter, qq, q = Quarter</p></li>
<li><p>month, mm, m = month</p></li>
<li><p>dayofyear = Day of the year</p></li>
<li><p>day, dy, y = Day</p></li>
<li><p>week, ww, wk = Week</p></li>
<li><p>weekday, dw, w = Weekday</p></li>
<li><p>hour, hh = hour</p></li>
<li><p>minute, mi, n = Minute</p></li>
<li><p>second, ss, s = Second</p></li>
<li><p>millisecond, ms = Millisecond</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">datediff</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">getdate</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;20200101&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">day</span><span class="p">,</span>
<span class="w">        </span><span class="n">datediff</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">getdate</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;20160101&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">month</span><span class="p">,</span>
<span class="w">        </span><span class="n">datediff</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span><span class="w"> </span><span class="n">getdate</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;20160101&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">year</span>
</pre></div>
</div>
</section>
<section id="Dateadd">
<h3><span class="section-number">2.13.2. </span>Dateadd<a class="headerlink" href="#Dateadd" title="Link to this heading"></a></h3>
<p>Dùng để cộng ngày</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">DATEADD</span><span class="p">(</span><span class="nb">interval</span><span class="p">,</span><span class="w"> </span><span class="n">number_to_add</span><span class="p">,</span><span class="w"> </span><span class="n">start_date</span><span class="p">)</span>

<span class="k">select</span><span class="w"> </span><span class="n">dateadd</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">getdate</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="Tricks-với-dữ-liệu-thời-gian">
<h3><span class="section-number">2.13.3. </span>Tricks với dữ liệu thời gian<a class="headerlink" href="#Tricks-với-dữ-liệu-thời-gian" title="Link to this heading"></a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Ngày đầu trong thaáng</span>
<span class="k">select</span><span class="w"> </span><span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="n">dateadd</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">datediff</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">getdate</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="mi">112</span><span class="p">)</span>

<span class="c1">-- Ngày đầu tháng này</span>
<span class="k">select</span><span class="w"> </span><span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
<span class="n">dateadd</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">datediff</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">getdate</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="mi">112</span><span class="p">)</span>

<span class="c1">-- Ngày đầu tháng trước</span>
<span class="k">select</span><span class="w"> </span><span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
<span class="n">dateadd</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">datediff</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">getdate</span><span class="p">())</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="mi">112</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="Các-nhóm-câu-lệnh-thay-đổi-dữ-liệu-trong-CSDL">
<h1><span class="section-number">3. </span>Các nhóm câu lệnh thay đổi dữ liệu trong CSDL<a class="headerlink" href="#Các-nhóm-câu-lệnh-thay-đổi-dữ-liệu-trong-CSDL" title="Link to this heading"></a></h1>
<section id="Tạo-bảng-mới">
<h2><span class="section-number">3.1. </span>Tạo bảng mới<a class="headerlink" href="#Tạo-bảng-mới" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><strong>Create table</strong>: Tạo bảng mới</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">Create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="p">[</span><span class="k">TABLE_NAME</span><span class="p">](</span>
<span class="n">VAR_1</span><span class="w"> </span><span class="k">TYPE</span><span class="w"> </span><span class="n">CONDITION</span><span class="p">,</span>
<span class="n">VAR_2</span><span class="w"> </span><span class="k">TYPE</span><span class="w"> </span><span class="n">CONDITION</span><span class="p">,</span>
<span class="p">...</span>
<span class="n">VAR_N</span><span class="w"> </span><span class="k">TYPE</span><span class="w"> </span><span class="n">CONDITION</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1">--Ví dụ</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">BILLS</span><span class="w"> </span><span class="p">(</span>
<span class="n">NAME</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="n">AMOUNT</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span>
<span class="n">ACCOUNT_ID</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="Xóa-bảng-Drop-Table">
<h2><span class="section-number">3.2. </span>Xóa bảng Drop Table<a class="headerlink" href="#Xóa-bảng-Drop-Table" title="Link to this heading"></a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">TABLE_NAME</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Kiểm tra điều kiện giá trị</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Tạo Bảng</span>
<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">test2</span>
<span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">Not</span><span class="w"> </span><span class="k">Null</span><span class="p">,</span>
<span class="w"> </span><span class="n">gender</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">check</span><span class="w"> </span><span class="p">(</span><span class="n">gender</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;F&#39;</span><span class="p">)))</span>

<span class="c1">-- Kiểm tra điều kiện khi insert</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test2</span><span class="w"> </span><span class="k">values</span>
<span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
<span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;F&#39;</span><span class="p">)</span>

<span class="c1">-- Alter điều kiện check</span>
<span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">test2</span>
<span class="k">add</span><span class="w"> </span><span class="k">check</span><span class="w"> </span><span class="p">(</span><span class="n">gender</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;F&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;MF&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;MF2&#39;</span><span class="p">))</span>

<span class="c1">-- Drop điều kiện check</span>
<span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">test2</span>
<span class="k">drop</span><span class="w"> </span><span class="k">constraint</span><span class="w"> </span><span class="n">CK__test2__gender__078C1F06</span>
</pre></div>
</div>
</section>
<section id="INSERT-INTO">
<h2><span class="section-number">3.3. </span>INSERT INTO<a class="headerlink" href="#INSERT-INTO" title="Link to this heading"></a></h2>
<p><strong>Chức năng</strong>: Chèn dòng vào dữ liệu</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="p">[</span><span class="k">table</span><span class="p">]</span>
<span class="p">(</span><span class="n">Column_1</span><span class="p">,</span><span class="w"> </span><span class="n">Column_2</span><span class="p">,...,</span><span class="w"> </span><span class="n">Column_n</span><span class="p">)</span>
<span class="k">values</span><span class="p">(</span><span class="n">Value_1</span><span class="p">,...,</span><span class="w"> </span><span class="n">Value_n</span><span class="p">)</span>

<span class="c1">-- Ví dụ</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">BILLS</span>
<span class="p">(</span><span class="n">NAME</span><span class="p">,</span><span class="w"> </span><span class="n">AMOUNT</span><span class="p">,</span><span class="w"> </span><span class="n">ACCOUNT_ID</span><span class="p">,</span><span class="w"> </span><span class="k">comment</span><span class="p">)</span>
<span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;ANH&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;OLA&#39;</span><span class="p">)</span>

<span class="c1">--Thêm tất cả các giá trị 1 bảng vào 1 bảng khác</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">new_2</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">all</span><span class="w"> </span><span class="n">columns</span><span class="p">)</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">bills</span>

<span class="c1">--Thêm một số giá trị của 1 bảng vào một bảng khác</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">new_2</span><span class="w"> </span><span class="p">(</span><span class="n">NAME</span><span class="p">,</span><span class="w"> </span><span class="k">comment</span><span class="p">)</span>
<span class="k">select</span><span class="w"> </span><span class="k">comment</span><span class="p">,</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">bills</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>:</p>
<ul class="simple">
<li><p>Khi insert into, để copy nhanh tên các bảng, ta có thể copy ra notepad</p></li>
<li><p>Khi viết tiếng Việt hoặc chèn ký tự tiếng Việt của Database cần có N ở phía trước. <code class="docutils literal notranslate"><span class="pre">N</span></code> cho phép SQL hiểu là <code class="docutils literal notranslate"><span class="pre">NVARCHAR</span></code>, cho phép nhóm ký tự UTF8</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">r2test</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">[</span><span class="n">mychar</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">NVARCHAR</span><span class="p">](</span><span class="mi">16</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="n">mynum</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">FLOAT</span><span class="p">])</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">r2test</span><span class="w"> </span><span class="p">(</span><span class="n">mychar</span><span class="p">,</span><span class="n">mynum</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span>
<span class="w">  </span><span class="p">(</span><span class="n">N</span><span class="s1">&#39;Đức Việt&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">.</span><span class="mi">141593</span><span class="p">)</span><span class="w"> </span><span class="c1">--Không lỗi</span>
<span class="w">  </span><span class="p">,(</span><span class="s1">&#39;Đức Việt&#39;</span><span class="p">,</span><span class="mi">6</span><span class="p">.</span><span class="mi">283185</span><span class="p">)</span><span class="w"> </span><span class="c1">--Lỗi font</span>

<span class="w">  </span><span class="n">Hải</span><span class="w"> </span><span class="n">Hoàng</span>
</pre></div>
</div>
</section>
<section id="Update">
<h2><span class="section-number">3.4. </span>Update<a class="headerlink" href="#Update" title="Link to this heading"></a></h2>
<p><strong>Chức năng</strong>: Thay đổi giá trị trong bảng</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">update</span><span class="w"> </span><span class="k">TABLE</span>
<span class="k">set</span><span class="w"> </span><span class="n">CONDITION_1</span>
<span class="k">where</span><span class="w"> </span><span class="n">CONDTION_2</span>

<span class="c1">--Ví dụ</span>
<span class="w">  </span><span class="k">update</span><span class="w"> </span><span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACC_TRANSACTION</span><span class="p">]</span>
<span class="w">  </span><span class="k">set</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9999</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TXN_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span>
</pre></div>
</div>
</section>
<section id="Delete-from">
<h2><span class="section-number">3.5. </span>Delete from<a class="headerlink" href="#Delete-from" title="Link to this heading"></a></h2>
<p><strong>Chức năng</strong>: Xóa giá trị</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DELETE</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">TABLE</span>
<span class="k">where</span><span class="w"> </span><span class="n">CONDITION</span>

<span class="c1">--Ví dụ</span>
<span class="w">  </span><span class="k">delete</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACC_TRANSACTION</span><span class="p">]</span>
<span class="w">  </span><span class="k">where</span><span class="w">  </span><span class="n">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9999</span>
</pre></div>
</div>
</section>
<section id="Alter-table">
<h2><span class="section-number">3.6. </span>Alter table<a class="headerlink" href="#Alter-table" title="Link to this heading"></a></h2>
<p><strong>Chức năng</strong>: Thêm xóa thêm cột mới</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">BILLS</span>
<span class="k">add</span><span class="o">/</span><span class="k">drop</span><span class="w"> </span><span class="n">NEW_VAR</span><span class="w"> </span><span class="k">TYPE</span>

<span class="c1">-- Thêm cột</span>
<span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">BILLS</span>
<span class="k">add</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

<span class="c1">-- Xóa cột</span>
<span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">BILLS</span>
<span class="k">drop</span><span class="w"> </span><span class="k">column</span><span class="w"> </span><span class="k">COLUMN_NAME</span>

<span class="c1">-- ALTER nhiều điều kiện</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">TABLE1</span>
<span class="k">set</span><span class="w"> </span><span class="n">column_in_TABLE1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="k">column</span>
<span class="k">from</span><span class="w"> </span><span class="n">table1</span><span class="w"> </span><span class="n">A</span>
<span class="w">  </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">table2</span><span class="w"> </span><span class="n">B</span>
<span class="w">  </span><span class="k">on</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">id</span>

<span class="c1">-- Ví dụ</span>

<span class="k">UPDATE</span><span class="w"> </span><span class="n">AVG_CASA_BAL_BY_CIF_2018_201902</span>
<span class="k">set</span><span class="w"> </span><span class="n">BI_CHANNEL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">BI_CHANNEL</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">AVG_CASA_BAL_BY_CIF_2018_201902</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">##</span><span class="n">B</span><span class="w"> </span><span class="n">B</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">CIF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">RECID</span>
</pre></div>
</div>
</section>
<section id="Đổi-tên-bảng,-tên-cột">
<h2><span class="section-number">3.7. </span>Đổi tên bảng, tên cột<a class="headerlink" href="#Đổi-tên-bảng,-tên-cột" title="Link to this heading"></a></h2>
<p>SQL không hỗ trợ trực tiếp rename bằng các hàm thông thường, phải dùng sp_rename</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Rename tên bảng</span>
<span class="n">sp_rename</span><span class="w"> </span><span class="s1">&#39;old_table&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;new_table&#39;</span>

<span class="c1">-- Rename tên cột trong bảng</span>
<span class="n">sp_rename</span><span class="w"> </span><span class="s1">&#39;table.old_column&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;new_column&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;column&#39;</span>
<span class="n">sp_rename</span><span class="w"> </span><span class="s1">&#39;my_table.var1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;variable1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;column&#39;</span>

<span class="c1">-- Rename tên cột trong bảng tạm</span>
<span class="n">tempdb</span><span class="p">.</span><span class="n">sys</span><span class="p">.</span><span class="n">sp_rename</span><span class="w"> </span><span class="s1">&#39;##a.var2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;variable2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;column&#39;</span>
</pre></div>
</div>
</section>
<section id="Truncate">
<h2><span class="section-number">3.8. </span>Truncate<a class="headerlink" href="#Truncate" title="Link to this heading"></a></h2>
<p><strong>Chức năng</strong>: Xóa toàn bộ dữ liệu trong bảng, dữ nguyên bảng</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">TRUNCATE</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">##</span><span class="n">A</span>
</pre></div>
</div>
</section>
<section id="ALTER---Thay-đổi-định-dạng-dữ-liệu-của-cột">
<h2><span class="section-number">3.9. </span>ALTER - Thay đổi định dạng dữ liệu của cột<a class="headerlink" href="#ALTER---Thay-đổi-định-dạng-dữ-liệu-của-cột" title="Link to this heading"></a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">CARD_LIVE_NEW</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">BUSINESS_DATE</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="Sub-Query">
<h1><span class="section-number">4. </span>Sub Query<a class="headerlink" href="#Sub-Query" title="Link to this heading"></a></h1>
<section id="Sub-Query-cơ-bản">
<h2><span class="section-number">4.1. </span>Sub Query cơ bản<a class="headerlink" href="#Sub-Query-cơ-bản" title="Link to this heading"></a></h2>
<p>Sub query thường được sử dụng sau điều kiện WHERE khi lọc điều kiện giữa nhiều bảng. Phần sub-queries được gọi là inner query. Xem lưu đồ dưới đây:</p>
<p><img alt="image1" src="_images/job_2.png" /></p>
<ul class="simple">
<li><p><strong>Trưởng hợp 1</strong>: Subquery sau WHERE</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--Biến thể 1</span>
<span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">TXN_ID</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">AMOUNT</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">AVAIL_BALANCE</span>
<span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACC_TRANSACTION</span><span class="p">]</span><span class="w"> </span><span class="n">a</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACCOUNT</span><span class="p">]</span><span class="w"> </span><span class="n">b</span>
<span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">TXN_ID</span><span class="w"> </span><span class="o">&gt;=</span>
<span class="w">  </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="p">(</span><span class="k">max</span><span class="p">(</span><span class="n">ACCOUNT_ID</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACCOUNT</span><span class="p">])</span>

<span class="c1">--Biến thể 2</span>
<span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">TXN_ID</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">AMOUNT</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">AVAIL_BALANCE</span>
<span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACC_TRANSACTION</span><span class="p">]</span><span class="w"> </span><span class="n">a</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACCOUNT</span><span class="p">]</span><span class="w"> </span><span class="n">b</span>
<span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">TXN_ID</span><span class="w"> </span><span class="k">in</span>
<span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">ACCOUNT_ID</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACCOUNT</span><span class="p">])</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Trường hợp 2</strong>: Subquery sau from</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">min</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">max</span>
<span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">acc_transaction</span><span class="p">)</span><span class="w"> </span><span class="n">a</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Trường hợp 3</strong>: Subquery trong select</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">Select</span><span class="w"> </span><span class="n">Cus</span><span class="p">.</span><span class="n">Cust_Id</span>
<span class="w">     </span><span class="p">,</span><span class="n">Cus</span><span class="p">.</span><span class="n">Address</span>
<span class="w">     </span><span class="p">,</span><span class="n">Cus</span><span class="p">.</span><span class="n">Fed_Id</span>
<span class="w">     </span><span class="p">,(</span><span class="k">Select</span><span class="w"> </span><span class="k">Sum</span><span class="p">(</span><span class="n">Acc</span><span class="p">.</span><span class="n">Avail_Balance</span><span class="p">)</span>
<span class="w">       </span><span class="k">From</span><span class="w">   </span><span class="n">Account</span><span class="w"> </span><span class="n">Acc</span>
<span class="w">       </span><span class="k">Where</span><span class="w">  </span><span class="n">Acc</span><span class="p">.</span><span class="n">Cust_Id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cus</span><span class="p">.</span><span class="n">Cust_Id</span><span class="p">)</span><span class="w"> </span><span class="k">As</span><span class="w"> </span><span class="n">Sum_Avail_Balance</span>
<span class="k">From</span><span class="w"> </span><span class="n">Customer</span><span class="w"> </span><span class="n">Cus</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>: Trong inner query/sub query, có 2 lưu ý sau:</p>
<ul class="simple">
<li><p>Phải liệt kê tất cả các bảng nếu các câu truy vấn có chứa biến từ bảng đó.</p></li>
<li><p>Các vị trí thường có trong subquery</p>
<ul>
<li><p>Subquery sau FROM: Kết quả của subquery cần được đặt tên</p></li>
<li><p>Subquery sau WHERE: Kết quả có thể không cần đặt tên</p></li>
</ul>
</li>
</ul>
</section>
<section id="Sử-dụng-WITH-thay-thế-subquery">
<h2><span class="section-number">4.2. </span>Sử dụng WITH thay thế subquery<a class="headerlink" href="#Sử-dụng-WITH-thay-thế-subquery" title="Link to this heading"></a></h2>
<p>Ta có thể dùng with để thay thế cho việc tạo bảng tạm sub query</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Khi dùng subquery</span>
<span class="k">select</span><span class="w"> </span><span class="o">#</span><span class="n">t2</span><span class="p">.</span><span class="o">*</span><span class="p">,</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">t3</span><span class="p">.[</span><span class="k">group</span><span class="p">]</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;Multi Booking&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;Single Booking&#39;</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">booking_type</span>
<span class="k">from</span><span class="w"> </span><span class="o">#</span><span class="n">t2</span>
<span class="w">    </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">cusid</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="k">group</span><span class="p">]</span>
<span class="w">                </span><span class="k">from</span><span class="w"> </span><span class="o">#</span><span class="n">t2</span><span class="w"> </span><span class="n">A</span>
<span class="w">                </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">cusid</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="k">group</span><span class="p">]</span>
<span class="w">                </span><span class="k">having</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">t3</span>
<span class="w">        </span><span class="k">on</span><span class="w"> </span><span class="o">#</span><span class="n">t2</span><span class="p">.</span><span class="n">cusid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T3</span><span class="p">.</span><span class="n">cusid</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="o">#</span><span class="n">t2</span><span class="p">.[</span><span class="k">group</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t3</span><span class="p">.[</span><span class="k">group</span><span class="p">]</span>

<span class="c1">-- Khi dùng with</span>
<span class="k">with</span><span class="w"> </span><span class="n">T3</span><span class="w"> </span><span class="k">AS</span>
<span class="w">    </span><span class="p">(</span><span class="k">selecT</span><span class="w"> </span><span class="n">CUSID</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="k">group</span><span class="p">]</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="o">#</span><span class="n">t2</span><span class="w"> </span><span class="n">A</span>
<span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">Cusid</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="k">group</span><span class="p">]</span>
<span class="w">    </span><span class="k">HAVING</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="p">)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">#</span><span class="n">t2</span><span class="p">.</span><span class="o">*</span><span class="w"> </span><span class="p">,</span>
<span class="w">    </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">T3</span><span class="p">.[</span><span class="k">group</span><span class="p">]</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;Multi booking&#39;</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;Single Booking&#39;</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">BOOKING_TYPE</span>
<span class="c1">--INTO #final_results</span>
<span class="k">FROM</span><span class="w"> </span><span class="o">#</span><span class="n">t2</span>
<span class="w">    </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">T3</span>
<span class="w">        </span><span class="k">ON</span><span class="w"> </span><span class="o">#</span><span class="n">t2</span><span class="p">.</span><span class="n">CUSID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T3</span><span class="p">.</span><span class="n">CUSID</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">#</span><span class="n">t2</span><span class="p">.[</span><span class="k">group</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T3</span><span class="p">.[</span><span class="k">group</span><span class="p">]</span>
</pre></div>
</div>
</section>
</section>
<section id="Các-nhóm-câu-lệnh-cơ-bản-khác">
<h1><span class="section-number">5. </span>Các nhóm câu lệnh cơ bản khác<a class="headerlink" href="#Các-nhóm-câu-lệnh-cơ-bản-khác" title="Link to this heading"></a></h1>
<section id="Exists">
<h2><span class="section-number">5.1. </span>Exists<a class="headerlink" href="#Exists" title="Link to this heading"></a></h2>
<p><strong>Chức năng</strong>: Kiểm tra điều kiện tồn tại</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">---Exist</span>
<span class="k">select</span><span class="w"> </span><span class="n">FirstName</span><span class="p">,</span>
<span class="w">           </span><span class="n">LastName</span>
<span class="k">from</span><span class="w"> </span><span class="n">DimEmployee</span>
<span class="k">where</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">LastName</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">DimCustomer</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">LastName</span><span class="w"> </span><span class="o">=</span>
<span class="s1">&#39;Zimmerman&#39;</span><span class="p">)</span>

<span class="c1">---Not exist</span>
<span class="k">select</span><span class="w"> </span><span class="n">FirstName</span><span class="p">,</span>
<span class="w">        </span><span class="n">LastName</span>
<span class="k">from</span><span class="w"> </span><span class="n">DimEmployee</span>
<span class="k">where</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">LastName</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">DimCustomer</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">LastName</span><span class="w"> </span><span class="o">=</span>
<span class="s1">&#39;Anh&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="Any-vs.-All">
<h2><span class="section-number">5.2. </span>Any vs. All<a class="headerlink" href="#Any-vs.-All" title="Link to this heading"></a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">---TH1: ANY</span>
<span class="k">select</span><span class="w"> </span><span class="n">EnglishProductName</span><span class="p">,</span><span class="w"> </span><span class="n">ListPrice</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">DimProduct</span>
<span class="k">where</span><span class="w"> </span><span class="n">ListPrice</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">all</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">any</span><span class="p">(</span><span class="n">ListPrice</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">DimProduct</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ProductSubcategoryKey</span><span class="p">)</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ListPrice</span><span class="w"> </span><span class="k">asc</span>

<span class="c1">--TH2: ALL without having</span>
<span class="k">select</span><span class="w"> </span><span class="n">EnglishProductName</span><span class="p">,</span><span class="w"> </span><span class="n">ListPrice</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">DimProduct</span>
<span class="k">where</span><span class="w"> </span><span class="n">ListPrice</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">all</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">ListPrice</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">DimProduct</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ProductSubcategoryKey</span><span class="p">)</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ListPrice</span><span class="w"> </span><span class="k">asc</span>

<span class="c1">--TH3: ALL with having</span>
<span class="k">select</span><span class="w"> </span><span class="n">EnglishProductName</span><span class="p">,</span><span class="w"> </span><span class="n">ListPrice</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">DimProduct</span>
<span class="k">where</span><span class="w"> </span><span class="n">ListPrice</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">all</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">ListPrice</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">DimProduct</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ProductSubcategoryKey</span>
<span class="k">having</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">ListPrice</span><span class="p">)</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">)</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ListPrice</span><span class="w"> </span><span class="k">asc</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>:</p>
<ul class="simple">
<li><p>Với TH1, truy vấn sẽ tìm tất cả các giá trị lớn hơn min của avg(ListPrice)</p></li>
<li><p>Với TH2, vì có 1 dòng trong inner query bị NULL, do đó toàn bộ câu lệnh sẽ không ra kết quả do KHÔNG CHẮC CHẮN điều kiện lọc lớn hơn TẤT CẢ các giá trị trong inner query</p></li>
<li><p>Với TH3, sử dụng having giúp loại đi điều kiện NULL</p></li>
</ul>
</section>
<section id="View">
<h2><span class="section-number">5.3. </span>View<a class="headerlink" href="#View" title="Link to this heading"></a></h2>
<p>View là hình thức tạo một bảng cho phép hiển thị, không tốn bộ nhớ thật của máy tính</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">Create</span><span class="w"> </span><span class="k">View</span><span class="w"> </span><span class="p">(</span><span class="n">COL_1</span><span class="p">,</span><span class="w"> </span><span class="n">COL_2</span><span class="p">...)</span><span class="w"> </span><span class="k">as</span>
<span class="k">select</span><span class="w"> </span><span class="n">COL_1</span><span class="p">,</span><span class="n">COL_2</span><span class="p">...</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">TABLE</span>

<span class="c1">--Ví dụ</span>
<span class="k">create</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="n">ducanh4</span><span class="w"> </span><span class="p">(</span><span class="n">CUS_ID</span><span class="p">,</span><span class="w"> </span><span class="n">MAIL</span><span class="p">)</span><span class="w"> </span><span class="k">as</span>
<span class="k">select</span><span class="w"> </span><span class="n">CUST_ID</span><span class="p">,</span><span class="w"> </span><span class="n">ADDRESS</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; ,&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">CITY</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">customer</span>

<span class="c1">--Lưu ý: Khi update trong View, ta sẽ update luôn thông tin từ bảng gốc</span>
<span class="k">create</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="n">ducanh5</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">account</span>
<span class="k">update</span><span class="w"> </span><span class="n">ducanh5</span>
<span class="k">set</span><span class="w"> </span><span class="n">AVAIL_BALANCE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AVAIL_BALANCE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">account</span>

<span class="c1">--DROP VIEW TABLE</span>
<span class="k">drop</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="n">ducanh5</span>
</pre></div>
</div>
</section>
<section id="Index">
<h2><span class="section-number">5.4. </span>Index<a class="headerlink" href="#Index" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Để tăng performance của query, ta có thể sử dụng Index. Index áp dụng B-Tree để tìm kiếm dữ liệu. Khi được đánh index, bảng sẽ là một bảng có cấu trúc, VD - theo thứ tự ABC. Nếu không đánh index, bảng sẽ được gọi là HEAP (nonsequential).</p></li>
<li><p>Khi đặt điều kiện unique key hoặc primary key, bảng sẽ tự động tạo index.</p></li>
<li><p>Khi tạo index, tốc độ truy vấn sẽ nhanh hơn tuy nhiên sẽ tốn dung lượng của ổ cứng lưu trữ</p></li>
</ul>
<p><img alt="image1" src="_images/job_2.png" /></p>
<p><strong>Cơ chế hoạt động</strong>:</p>
<ul class="simple">
<li><p>Nếu cột customer_name được sử dụng làm index, sẽ chia làm 3 nhóm A, Q, T. Nếu tên khách hàng bắt đầu là R, sẽ nhảy luôn đến nhóm index Q &gt;&gt; R &gt;&gt; Tìm tên</p></li>
<li><p>Nếu không có index, sẽ phải scan từng dòng trong cả bảng để tìm</p></li>
<li><p>Trong SQL có 2 loại index: Clustered Index và Non-cluster index. Với cluster index, leaf - node cuối trong Btree, chứa toàn bộ thông tin của dòng dữ liệu. Với Non-cluster index, leaf trong Btree chỉ chứa index.</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Clustered index</span>
<span class="k">create</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">new_2</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">test2</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">gender</span><span class="p">)</span>

<span class="c1">--Non clustered index</span>
<span class="k">create</span><span class="w"> </span><span class="n">nonclustered</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">test_id</span>
<span class="k">on</span><span class="w"> </span><span class="n">test</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>

<span class="c1">-- Drop index</span>
<span class="k">drop</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">new_2</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">test2</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Bảng có index sẽ hoạt động nhanh hơn bảng thường do cơ chế sau:</p>
<ul>
<li><p>Không có index: Scan từng dòng trong bảng và tìm điều kiện</p></li>
<li><p>Có index: Tìm theo khu vực index. VD: ID = 5</p>
<ul>
<li><p>Nếu không có index, sẽ tìm từng dòng và trả về kết quả với ID = 5.</p></li>
<li><p>Nếu có index, sẽ tìm với thuật toán chia đôi</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Các loại index:</p>
<ul>
<li><p>Clustered: Sắp xếp lại cách lưu trữ dữ liệu trong DB</p></li>
<li><p>Nonclustered: Không sắp xếp</p></li>
</ul>
</li>
</ul>
</section>
<section id="Bảng-tạm">
<h2><span class="section-number">5.5. </span>Bảng tạm<a class="headerlink" href="#Bảng-tạm" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Bảng tạm là bảng chỉ tồn tại trong 1 session của SQL. Sau khi log out hoặc khởi động lại, bảng này sẽ tự động biến mấ.</p></li>
<li><p>Bảng tạm bắt đầu bằng dấu #</p></li>
<li><p>Bảng tạm với 1 dấu # gọi là bảng tạm local - sẽ tự xóa khi đóng query editor. Bạng tạm với ## gọi là bảng tạm global - chỉ xóa khi thoát khỏi SQL</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--Chỉ tạo bảng</span>
<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">#</span><span class="n">da</span><span class="w"> </span><span class="p">(</span><span class="n">VAr1</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="n">var2</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span>

<span class="c1">--Vừa tạo bảng vừa insert</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span>
<span class="k">into</span><span class="w"> </span><span class="o">#</span><span class="n">ducanh</span>
<span class="k">from</span><span class="w"> </span><span class="n">account</span>
</pre></div>
</div>
</section>
<section id="Kiểm-tra-kiểu-dữ-liệu-trong-bảng">
<h2><span class="section-number">5.6. </span>Kiểm tra kiểu dữ liệu trong bảng<a class="headerlink" href="#Kiểm-tra-kiểu-dữ-liệu-trong-bảng" title="Link to this heading"></a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">COLUMN_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">DATA_TYPE</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">INFORMATION_SCHEMA</span><span class="p">.</span><span class="n">COLUMNS</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">TABLE_NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ACCOUNT&#39;</span><span class="w"> </span><span class="c1">-- Điền tên bảng</span>
</pre></div>
</div>
</section>
</section>
<section id="SQL-động-với-Exec">
<h1><span class="section-number">6. </span>SQL động với Exec<a class="headerlink" href="#SQL-động-với-Exec" title="Link to this heading"></a></h1>
<p>SQL động là nhóm sử dụng nâng cao của SQL, cho phép người dùng tự động hóa các script. Sử dụng SQL động cho phép tùy biến các câu lệnh khi truy vấn và xử lý dữ liệu. Khi sử dụng SQL động, ta cần dùng <code class="docutils literal notranslate"><span class="pre">EXEC</span></code></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Cách 1</span>
<span class="k">declare</span><span class="w"> </span><span class="o">@</span><span class="n">id</span><span class="w"> </span><span class="nb">int</span>
<span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;4&#39;</span>
<span class="k">exec</span><span class="p">(</span><span class="s1">&#39;select * from ACCOUNT where ACCOUNT_ID = &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">id</span><span class="p">)</span>

<span class="c1">-- Cách 2</span>
<span class="k">declare</span><span class="w"> </span><span class="o">@</span><span class="n">id</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;4&#39;</span>
<span class="k">declare</span><span class="w"> </span><span class="o">@</span><span class="k">sql</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="k">sql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;select * from ACCOUNT where account_id = &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">id</span>
<span class="n">print</span><span class="w"> </span><span class="o">@</span><span class="k">sql</span><span class="w"> </span><span class="c1">-- Đảm bảo câu lệnh thực hiện đúng</span>
<span class="k">exec</span><span class="p">(</span><span class="o">@</span><span class="k">sql</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Lưu ý khi sử dụng SQL động</strong></p>
<ul class="simple">
<li><p>Lưu ý dấu cách</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXEC</span><span class="p">(</span><span class="s1">&#39; SELECT col1, col2, col3 &#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">     </span><span class="s1">&#39; FROM &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tblname</span><span class="w"> </span><span class="o">+</span>
<span class="w">     </span><span class="s1">&#39; WHERE keycol = &#39;&#39;&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="k">key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Luôn dùng print để đảm bảo viết đúng câu lệnh trước khi sử dụng exec</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">declare</span><span class="w"> </span><span class="o">@</span><span class="k">month</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="nb">date</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">##</span><span class="n">A</span><span class="p">)</span>
<span class="n">print</span><span class="p">(</span><span class="s1">&#39;select * from ##B where month = &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="k">month</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="Hàm-và-thủ-tục">
<h1><span class="section-number">7. </span>Hàm và thủ tục<a class="headerlink" href="#Hàm-và-thủ-tục" title="Link to this heading"></a></h1>
<section id="Procedure">
<h2><span class="section-number">7.1. </span>Procedure<a class="headerlink" href="#Procedure" title="Link to this heading"></a></h2>
<section id="Hiển-thị-tất-cả-các-procedure-đang-lưu-trong-hệ-thống">
<h3><span class="section-number">7.1.1. </span>Hiển thị tất cả các procedure đang lưu trong hệ thống<a class="headerlink" href="#Hiển-thị-tất-cả-các-procedure-đang-lưu-trong-hệ-thống" title="Link to this heading"></a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Tất cả các procedure</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">name</span><span class="p">,</span>
<span class="w">       </span><span class="k">type</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">sysobjects</span>
<span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;P&#39;</span><span class="p">)</span>

<span class="c1">-- Các procedure do người dùng tạo</span>
<span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="o">*</span>
<span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="n">master</span><span class="p">.</span><span class="n">information_schema</span><span class="p">.</span><span class="n">routines</span>
<span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="n">routine_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;PROCEDURE&#39;</span>
<span class="w">        </span><span class="k">and</span><span class="w"> </span><span class="k">Left</span><span class="p">(</span><span class="k">Routine_Name</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;sp_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;xp_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ms_&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Xóa procedure</strong></p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">drop</span><span class="w"> </span><span class="k">procedure</span><span class="w"> </span><span class="n">cast_data</span>
</pre></div>
</div>
</section>
<section id="Tạo-procedure">
<h3><span class="section-number">7.1.2. </span>Tạo procedure<a class="headerlink" href="#Tạo-procedure" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Procedure không có biến</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Tạo procedure</span>
<span class="k">create</span><span class="w"> </span><span class="k">procedure</span><span class="w"> </span><span class="n">getID_normal</span>
<span class="k">as</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">ACCOUNT</span>
<span class="c1">-- Chạy procedure</span>
<span class="k">execute</span><span class="w"> </span><span class="n">getID_normal</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Procedure nhiều biến</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--Tạo procedure</span>
<span class="k">create</span><span class="w"> </span><span class="k">procedure</span><span class="w"> </span><span class="n">PROD_CD</span>
<span class="w">  </span><span class="o">@</span><span class="n">prod</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="o">@</span><span class="n">AVAIL_BALANCE</span><span class="w"> </span><span class="nb">float</span>
<span class="k">as</span>
<span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">ACCOUNT</span>
<span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="n">PRODUCT_CD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">prod</span><span class="w"> </span><span class="k">and</span>
<span class="w">  </span><span class="n">AVAIL_BALANCE</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">@</span><span class="n">AVAIL_BALANCE</span>
<span class="k">GO</span>

<span class="c1">--Chạy procedure</span>
<span class="n">PROD_CD</span><span class="w"> </span><span class="o">@</span><span class="n">prod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;CHK&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">AVAIL_BALANCE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>: Trong SQL có 2 loại biến:</p>
<ul class="simple">
<li><p>User defined variable: Bắt đầu bằng dấu <a class="reference external" href="mailto:**&#37;&#52;&#48;**">**<span>&#64;</span>**</a></p></li>
<li><p>System variable: Bắt đầu bằng dấu **&#64;&#64;** - loại này chỉ xuất hiện sau khi đã thực hiện xong 1 số câu lệnh</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">[</span><span class="n">DimCustomer</span><span class="p">]</span>
<span class="k">select</span><span class="w"> </span><span class="o">@@</span><span class="n">ROWCOUNT</span>
</pre></div>
</div>
</section>
<section id="Gán-kết-quả-1-procedure-vào-biến">
<h3><span class="section-number">7.1.3. </span>Gán kết quả 1 procedure vào biến<a class="headerlink" href="#Gán-kết-quả-1-procedure-vào-biến" title="Link to this heading"></a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">drop</span><span class="w"> </span><span class="k">procedure</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="n">return_date</span>
<span class="k">create</span><span class="w"> </span><span class="k">procedure</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">return_date</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">no_date</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">no_date2</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">  </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="k">output</span><span class="p">)</span>
<span class="k">as</span>
<span class="k">begin</span>
<span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="n">getdate</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">@</span><span class="n">no_date</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">no_date2</span><span class="p">,</span><span class="w"> </span><span class="mi">112</span><span class="p">))</span>
<span class="k">end</span>

<span class="k">declare</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="k">execute</span><span class="w"> </span><span class="n">return_date</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="k">output</span>
<span class="n">print</span><span class="w"> </span><span class="o">@</span><span class="k">result</span>
</pre></div>
</div>
</section>
</section>
<section id="Hàm-(function)">
<h2><span class="section-number">7.2. </span>Hàm (function)<a class="headerlink" href="#Hàm-(function)" title="Link to this heading"></a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DROP</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">fn_return_date</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">fn_return_date</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">no_date</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">INT</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="k">SELECT</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="k">convert</span><span class="p">(</span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="n">getdate</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">@</span><span class="n">no_date</span><span class="p">,</span><span class="w"> </span><span class="mi">112</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">INT</span><span class="p">)</span>
<span class="w">            </span><span class="p">)</span>
<span class="k">END</span><span class="p">;</span>

<span class="c1">-- Cách 1</span>
<span class="k">declare</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="nb">int</span>
<span class="k">select</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">fn_return_date</span><span class="p">](</span><span class="mi">4</span><span class="p">)</span>
<span class="n">print</span><span class="w"> </span><span class="o">@</span><span class="k">result</span>

<span class="c1">-- Cách 2</span>
<span class="k">declare</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="nb">int</span>
<span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="n">dbo</span><span class="p">].[</span><span class="n">fn_return_date</span><span class="p">](</span><span class="mi">4</span><span class="p">))</span>
<span class="n">print</span><span class="w"> </span><span class="o">@</span><span class="k">result</span>
</pre></div>
</div>
</section>
</section>
<section id="Các-nhóm-câu-lệnh-nâng-cao">
<h1><span class="section-number">8. </span>Các nhóm câu lệnh nâng cao<a class="headerlink" href="#Các-nhóm-câu-lệnh-nâng-cao" title="Link to this heading"></a></h1>
<section id="If...Else">
<h2><span class="section-number">8.1. </span>If…Else<a class="headerlink" href="#If...Else" title="Link to this heading"></a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="k">begin</span>
<span class="n">print</span><span class="w"> </span><span class="s1">&#39;wrong&#39;</span>
<span class="n">print</span><span class="w"> </span><span class="s1">&#39;not sure&#39;</span>
<span class="k">end</span>
<span class="k">else</span>
<span class="k">begin</span>
<span class="n">print</span><span class="w"> </span><span class="s1">&#39;right&#39;</span>
<span class="n">print</span><span class="w"> </span><span class="s1">&#39;absolutely right&#39;</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>: Sau mệnh đề else, if, nếu có nhiều câu lệnh cùng thực hiện, cần khai báo begin…end</p>
</section>
<section id="Check-điều-kiện-để-thực-thi-tiếp">
<h2><span class="section-number">8.2. </span>Check điều kiện để thực thi tiếp<a class="headerlink" href="#Check-điều-kiện-để-thực-thi-tiếp" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Kiểm tra điều kiện tồn tại của bảng</p></li>
<li><p>Nếu tồn tại, chạy tiếp</p></li>
<li><p>Nếu không tồn tại, skip các câu lệnh tiếp theo</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--SQL CMD</span>
<span class="p">:</span><span class="k">on</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">exit</span>

<span class="k">declare</span><span class="w"> </span><span class="o">@</span><span class="n">tbl</span><span class="w"> </span><span class="n">sysname</span>
<span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="n">tbl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;TBL_I2B_USERS_F0_20180502&#39;</span>

<span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">ANHNT67</span><span class="p">.</span><span class="n">DBS_DAILY</span><span class="p">.</span><span class="n">DBO</span><span class="p">.</span><span class="n">SYSOBJECTS</span>
<span class="w">                </span><span class="k">WHERE</span><span class="w"> </span><span class="n">NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">tbl</span><span class="p">)</span>
<span class="k">BEGIN</span>
<span class="n">raiserror</span><span class="p">(</span><span class="s1">&#39;Table does not exist&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="n">print</span><span class="p">(</span><span class="o">@</span><span class="n">tbl</span><span class="p">)</span>
<span class="k">return</span>
<span class="k">END</span>

<span class="k">EXEC</span><span class="p">(</span><span class="s1">&#39;select top 10 * FROM ANHNT67.DBS_DAILY.DBO.&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tbl</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="Vòng-lặp-với-bảng">
<h2><span class="section-number">8.3. </span>Vòng lặp với bảng<a class="headerlink" href="#Vòng-lặp-với-bảng" title="Link to this heading"></a></h2>
<p>SQL chỉ chạy được vòng lặp <code class="docutils literal notranslate"><span class="pre">WHILE</span></code></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DROP</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">fn_return_date</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">fn_return_date</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">no_date</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">INT</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="k">SELECT</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="k">convert</span><span class="p">(</span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="n">getdate</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">@</span><span class="n">no_date</span><span class="p">,</span><span class="w"> </span><span class="mi">112</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">INT</span><span class="p">)</span>
<span class="w">            </span><span class="p">)</span>
<span class="k">END</span><span class="p">;</span>

<span class="k">declare</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="nb">int</span>
<span class="k">select</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">fn_return_date</span><span class="p">](</span><span class="mi">4</span><span class="p">)</span>
<span class="n">print</span><span class="w"> </span><span class="o">@</span><span class="k">result</span>

<span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="o">#</span><span class="n">temp</span>
<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">#</span><span class="n">temp</span><span class="w"> </span><span class="p">(</span><span class="nb">date</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">#</span><span class="n">temp</span>

<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="o">#</span><span class="n">temp</span><span class="w"> </span><span class="p">(</span><span class="nb">date</span><span class="p">)</span>
<span class="k">select</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">fn_return_date</span><span class="p">](</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">date</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="o">#</span><span class="n">temp</span><span class="w"> </span><span class="p">(</span><span class="nb">date</span><span class="p">)</span>
<span class="k">select</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">fn_return_date</span><span class="p">](</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">date</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="o">#</span><span class="n">temp</span><span class="w"> </span><span class="p">(</span><span class="nb">date</span><span class="p">)</span>
<span class="k">select</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">fn_return_date</span><span class="p">](</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">date</span>

<span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="o">#</span><span class="n">temp2</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span>
<span class="k">into</span><span class="w"> </span><span class="o">#</span><span class="n">temp2</span>
<span class="k">from</span><span class="w"> </span><span class="o">#</span><span class="n">temp</span>

<span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">#</span><span class="n">temp2</span>
<span class="k">add</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">#</span><span class="n">temp2</span>

<span class="k">update</span><span class="w"> </span><span class="o">#</span><span class="n">temp2</span>
<span class="k">set</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="nb">date</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;abc&#39;</span>


<span class="c1">--Reference</span>
<span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="o">#</span><span class="k">ref</span>

<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">#</span><span class="k">ref</span><span class="w"> </span><span class="p">(</span>
<span class="p">[</span><span class="k">index</span><span class="p">]</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">identity</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="p">[</span><span class="nb">date</span><span class="p">]</span><span class="w"> </span><span class="nb">int</span>
<span class="p">)</span>

<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="o">#</span><span class="k">ref</span><span class="w"> </span><span class="p">(</span><span class="nb">date</span><span class="p">)</span>
<span class="k">select</span><span class="w"> </span><span class="p">[</span><span class="nb">date</span><span class="p">]</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">#</span><span class="n">temp</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="p">[</span><span class="nb">date</span><span class="p">]</span>

<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">#</span><span class="k">ref</span>

<span class="c1">-- VERSION 1: DOES NOT WORK</span>

<span class="k">declare</span><span class="w"> </span><span class="o">@</span><span class="n">loopcounter</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">maxcounter</span><span class="w"> </span><span class="nb">int</span>
<span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="n">loopcounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="nb">date</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">#</span><span class="n">temp2</span><span class="p">)</span>
<span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="n">maxcounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="nb">date</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">#</span><span class="n">temp2</span><span class="p">)</span>

<span class="n">while</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">loopcounter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">@</span><span class="n">maxcounter</span><span class="p">)</span>
<span class="k">begin</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">#</span><span class="n">temp2</span><span class="w"> </span><span class="k">where</span>
<span class="w">    </span><span class="nb">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">loopcounter</span>
<span class="w">    </span><span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="n">loopcounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">loopcounter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="k">end</span>


<span class="c1">-- VERSION 2: WORK WELL</span>
<span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="o">#</span><span class="k">result</span>
<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">#</span><span class="k">result</span><span class="w"> </span><span class="p">(</span><span class="nb">date</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">#</span><span class="k">result</span>

<span class="k">declare</span><span class="w"> </span><span class="o">@</span><span class="n">loopcounter</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">maxcounter</span><span class="w"> </span><span class="nb">int</span>
<span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="n">loopcounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">min</span><span class="p">([</span><span class="k">index</span><span class="p">])</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">#</span><span class="k">ref</span><span class="p">)</span>
<span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="n">maxcounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">max</span><span class="p">([</span><span class="k">index</span><span class="p">])</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">#</span><span class="k">ref</span><span class="p">)</span>

<span class="n">while</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">loopcounter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">@</span><span class="n">maxcounter</span><span class="p">)</span>
<span class="k">begin</span>
<span class="w">    </span><span class="k">declare</span><span class="w"> </span><span class="o">@</span><span class="nb">date</span><span class="w"> </span><span class="nb">int</span>
<span class="w">    </span><span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="nb">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="p">[</span><span class="nb">date</span><span class="p">]</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">#</span><span class="k">ref</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="p">[</span><span class="k">index</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">loopcounter</span><span class="p">)</span>

<span class="w">    </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="o">#</span><span class="k">result</span><span class="w"> </span><span class="p">([</span><span class="nb">date</span><span class="p">],</span><span class="w"> </span><span class="k">new</span><span class="p">)</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">#</span><span class="n">temp2</span><span class="w"> </span><span class="k">where</span>
<span class="w">    </span><span class="p">[</span><span class="nb">date</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="nb">date</span>
<span class="w">    </span><span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="n">loopcounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">loopcounter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="k">end</span>

<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">#</span><span class="k">result</span>
</pre></div>
</div>
</section>
</section>
<section id="Đặt-job-trong-SQL">
<h1><span class="section-number">9. </span>Đặt job trong SQL<a class="headerlink" href="#Đặt-job-trong-SQL" title="Link to this heading"></a></h1>
<p>Khi làm việc với SQL, một trong những yêu cầu rất quan trọng là phải tự động hóa code SQL theo thơi gian. Yêu cầu này có thể được xử lý bằng cách đặt job thông qua các bước lớn sau.</p>
<ul class="simple">
<li><p>Active email tự động</p></li>
<li><p>Đăng ký email</p></li>
<li><p>Active SQL Server Agent</p></li>
<li><p>Đặt job</p></li>
</ul>
<section id="Bước-1:-Active-email-tự-động">
<h2><span class="section-number">9.1. </span>Bước 1: Active email tự động<a class="headerlink" href="#Bước-1:-Active-email-tự-động" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Thực hiện câu lệnh sau trên SQL để active gửi Database Mail. Do khi cài SQL, mặc định Database mail chưa được active nên khi sử dụng ta cần active database này</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">sp_configure</span><span class="w"> </span><span class="s1">&#39;show advanced options&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="k">GO</span>
<span class="n">RECONFIGURE</span><span class="p">;</span>
<span class="k">GO</span>
<span class="n">sp_configure</span><span class="w"> </span><span class="s1">&#39;Database Mail XPs&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="k">GO</span>
<span class="n">RECONFIGURE</span>
<span class="k">GO</span>
</pre></div>
</div>
</section>
<section id="Bước-2:-Đăng-kí-email-trong-Database-mail">
<h2><span class="section-number">9.2. </span>Bước 2: Đăng kí email trong Database mail<a class="headerlink" href="#Bước-2:-Đăng-kí-email-trong-Database-mail" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Tại màn hình SQL &gt;&gt; Object Explore &gt;&gt; Management &gt;&gt; Database Mail &gt;&gt; Tick vào Set up database Mail by performing the following tasks &gt;&gt; Next &gt;&gt; Profile name điền tên id của mình muốn &gt;&gt; Add &gt;&gt; Điền đẩy đủ thông tin như hình bên dưới với thông tin email &gt;&gt; Next</p></li>
<li><p>Mục đích của bước này là sau khi hoàn thành Job ta sẽ có 1 email thông báo Job đã thành công hoặc gửi thẳng cho client là dữ liệu đã sẵn sàng để có thể sử dụng</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">ID</span><span class="p">:</span><span class="w"> </span><span class="n">email</span>
<span class="n">Pass</span><span class="p">:</span><span class="w"> </span><span class="n">pwd</span>
</pre></div>
</div>
<p><img alt="Template" src="_images/job_5.png" /></p>
<hr class="docutils" />
<p><img alt="image1" src="_images/job_2.png" /></p>
</section>
<hr class="docutils" />
<section id="Bước-3:-Active-SQL-Server-Agent">
<h2><span class="section-number">9.3. </span>Bước 3: Active SQL Server Agent<a class="headerlink" href="#Bước-3:-Active-SQL-Server-Agent" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Tại Object Explore &gt;&gt; Click chuột phải vào SQL Server Agent &gt;&gt; Start</p></li>
</ul>
</section>
<section id="Bước-4:-Đặt-Job">
<h2><span class="section-number">9.4. </span>Bước 4: Đặt Job<a class="headerlink" href="#Bước-4:-Đặt-Job" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Chuột phải vào SQL Server Agent &gt;&gt; New &gt;&gt; Điền Name vào mục General &gt;&gt; Qua mục Steps &gt;&gt; Tạo các bước của Job tại New &gt;&gt; Điền Step Name &gt;&gt; Paste code automate vào phần Command. Ví dụ có thể sử dụng tại code bên dưới</p></li>
</ul>
<center><p><img alt="image2" src="_images/job_3.png" /></p>
</center><hr class="docutils" />
<center><p><img alt="image3" src="_images/job_4.png" /></p>
</center><hr class="docutils" />
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">BA</span><span class="p">].[</span><span class="n">INFORMATION_SCHEMA</span><span class="p">].[</span><span class="n">TABLES</span><span class="p">]</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="p">[</span><span class="k">TABLE_NAME</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;CREDIT_CARD_TRANSACTION_SUCCESSFUL_MASTER&#39;</span><span class="p">)</span>
<span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">BA</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">CREDIT_CARD_TRANSACTION_SUCCESSFUL_MASTER</span><span class="p">]</span>

<span class="k">EXEC</span><span class="p">(</span><span class="s1">&#39;</span>
<span class="s1">SELECT  ID,</span>
<span class="s1">        YEARMONTH,</span>
<span class="s1">        TARGET_ID,</span>
<span class="s1">        TRANS_DATE,</span>
<span class="s1">        TRANS_CURR,</span>
<span class="s1">        TRANS_AMOUNT_QD,</span>
<span class="s1">        TRANS_DETAILS,</span>
<span class="s1">        MERCHANT_ID,</span>
<span class="s1">        TRANS_CITY,</span>
<span class="s1">        TRANS_COUNTRY,</span>
<span class="s1">        BI_TRANS_TYPE,</span>
<span class="s1">        SIC_CODE,</span>
<span class="s1">        CIF,</span>
<span class="s1">        PRODUCT_DETAIL</span>
<span class="s1">INTO [BA].[dbo].[CREDIT_CARD_TRANSACTION_SUCCESSFUL_MASTER]</span>
<span class="s1">FROM [BA].[dbo].[CREDIT_CARD_TRANSACTION_SUCCESSFUL_2018]</span>
<span class="s1">UNION ALL</span>
<span class="s1">SELECT  ID,</span>
<span class="s1">        YEARMONTH,</span>
<span class="s1">        TARGET_ID,</span>
<span class="s1">        TRANS_DATE,</span>
<span class="s1">        TRANS_CURR,</span>
<span class="s1">        TRANS_AMOUNT_QD,</span>
<span class="s1">        TRANS_DETAILS,</span>
<span class="s1">        MERCHANT_ID,</span>
<span class="s1">        TRANS_CITY,</span>
<span class="s1">        TRANS_COUNTRY,</span>
<span class="s1">        BI_TRANS_TYPE,</span>
<span class="s1">        SIC_CODE,</span>
<span class="s1">        CIF,</span>
<span class="s1">        PRODUCT_DETAIL</span>
<span class="s1">FROM [BA].[dbo].[CREDIT_CARD_TRANSACTION_SUCCESSFUL_2017]</span>
<span class="s1">&#39;</span><span class="p">)</span>

<span class="k">EXEC</span><span class="p">(</span><span class="s1">&#39;</span>
<span class="s1">ALTER TABLE [BA].[dbo].[CREDIT_CARD_TRANSACTION_SUCCESSFUL_MASTER]</span>
<span class="s1">ADD SIC_ID VARCHAR(MAX), MCC_CATEGORY VARCHAR(MAX), MCC_CATEGORY_AIA VARCHAR(MAX)</span>
<span class="s1">&#39;</span><span class="p">)</span>

<span class="k">EXEC</span><span class="p">(</span><span class="s1">&#39;</span>
<span class="s1">UPDATE [BA].[dbo].[CREDIT_CARD_TRANSACTION_SUCCESSFUL_MASTER]</span>
<span class="s1">SET SIC_ID = A.SIC_CODE collate database_default,</span>
<span class="s1">    MCC_CATEGORY = A.CATEGORIES</span>
<span class="s1">FROM [BA].[dbo].[MCC_CATEGORY_20170808] A</span>
<span class="s1">WHERE [BA].[dbo].[CREDIT_CARD_TRANSACTION_SUCCESSFUL_MASTER].SIC_CODE = A.SIC_ID</span>

<span class="s1">UPDATE [BA].[dbo].[CREDIT_CARD_TRANSACTION_SUCCESSFUL_MASTER]</span>
<span class="s1">SET MCC_CATEGORY_AIA = A.MCC_CATEGORY</span>
<span class="s1">FROM [BA].[dbo].[MCC_CATEGORY_AIA_20180307] A</span>
<span class="s1">WHERE [BA].[dbo].[CREDIT_CARD_TRANSACTION_SUCCESSFUL_MASTER].SIC_CODE = A.SIC_ID</span>
<span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Tạo bước gửi email đến Client &gt;&gt; Đặt tên là SUCCESSFUL JOB &gt;&gt; ta làm tương tự các bước như trên với code trong mục command như sau.</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">USE</span><span class="w"> </span><span class="p">[</span><span class="n">msdb</span><span class="p">]</span>
<span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">REPORT_DATE</span><span class="w"> </span><span class="nb">DATE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">TRANS_DATE</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w">  </span><span class="n">BA</span><span class="p">..</span><span class="n">CREDIT_CARD_TRANSACTION_SUCCESSFUL_MASTER</span><span class="p">);</span>
<span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">SUBJECT</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">250</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;[JOB DONE] - CREDIT CARD TRANSACTION - &#39;</span><span class="o">+</span><span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="o">@</span><span class="n">REPORT_DATE</span><span class="p">,</span><span class="mi">112</span><span class="p">);</span>
<span class="k">EXEC</span>
<span class="n">sp_send_dbmail</span>
<span class="o">@</span><span class="n">profile_name</span><span class="w"> </span><span class="o">=</span><span class="s1">&#39;thanh&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">recipients</span><span class="w"> </span><span class="o">=</span><span class="s1">&#39;thanhnm3@vpbank.com.vn; truongnh3@vpbank.com.vn; lambt1@vpbank.com.vn&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">subject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">SUBJECT</span><span class="p">,</span>
<span class="o">@</span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="n">N</span><span class="s1">&#39;CREDIT CARD TRANSACTION IS AVAILABLE&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">execute_query_database</span><span class="w"> </span><span class="o">=</span><span class="s1">&#39;msdb&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Tạo bước gửi email đến chính mình khi JOB bị failed &gt;&gt; Đặt tên là FAILED JOB &gt;&gt; ta làm tương tự các bước như trên với code trong mục command như sau.</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">USE</span><span class="w"> </span><span class="p">[</span><span class="n">msdb</span><span class="p">]</span>
<span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">REPORT_DATE</span><span class="w"> </span><span class="nb">DATE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">TRANS_DATE</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w">  </span><span class="n">BA</span><span class="p">..</span><span class="n">CREDIT_CARD_TRANSACTION_SUCCESSFUL_MASTER</span><span class="p">);</span>
<span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">SUBJECT</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">250</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;[JOB DONE] - CREDIT CARD TRANSACTION - &#39;</span><span class="o">+</span><span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="o">@</span><span class="n">REPORT_DATE</span><span class="p">,</span><span class="mi">112</span><span class="p">);</span>
<span class="k">EXEC</span>
<span class="n">sp_send_dbmail</span>
<span class="o">@</span><span class="n">profile_name</span><span class="w"> </span><span class="o">=</span><span class="s1">&#39;thanh&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">recipients</span><span class="w"> </span><span class="o">=</span><span class="s1">&#39;thanhnm3@vpbank.com.vn&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">subject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">SUBJECT</span><span class="p">,</span>
<span class="o">@</span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="n">N</span><span class="s1">&#39;CREDIT CARD TRANSACTION HAS BEEN FAILED&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">execute_query_database</span><span class="w"> </span><span class="o">=</span><span class="s1">&#39;msdb&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Sửa lại cách thức chạy code của các bước &gt;&gt; Double Click vào step 1 &gt;&gt; Chọn Advanced &gt;&gt; Tại On failure action &gt;&gt; Chọn go to FAILED JOB (step đặt mail báo failed)</p></li>
</ul>
<center><p><img alt="Template" src="_images/job_5.png" /></p>
</center><hr class="docutils" />
<p><strong>Lưu ý</strong></p>
<ul class="simple">
<li><p>Code SQL được đưa vào trong JOB cần là code tự động</p></li>
</ul>
</section>
</section>
<section id="Các-nhóm-câu-lệnh-quản-trị">
<h1><span class="section-number">10. </span>Các nhóm câu lệnh quản trị<a class="headerlink" href="#Các-nhóm-câu-lệnh-quản-trị" title="Link to this heading"></a></h1>
<section id="Tìm-kiếm-các-query-đang-chạy">
<h2><span class="section-number">10.1. </span>Tìm kiếm các query đang chạy<a class="headerlink" href="#Tìm-kiếm-các-query-đang-chạy" title="Link to this heading"></a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Cách 1</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">dm_exec_requests</span>
<span class="k">where</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;running&#39;</span>

<span class="c1">-- Cách 2</span>
<span class="k">exec</span><span class="w"> </span><span class="n">sp_who</span>
<span class="k">exec</span><span class="w"> </span><span class="n">sp_who2</span>
<span class="k">exec</span><span class="w"> </span><span class="n">sp_who3</span>

<span class="c1">-- Cách 3</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">sqltext</span><span class="p">.</span><span class="nb">TEXT</span><span class="p">,</span>
<span class="n">req</span><span class="p">.</span><span class="n">session_id</span><span class="p">,</span>
<span class="n">req</span><span class="p">.</span><span class="n">status</span><span class="p">,</span>
<span class="n">req</span><span class="p">.</span><span class="n">start_time</span><span class="p">,</span>
<span class="n">req</span><span class="p">.</span><span class="n">command</span><span class="p">,</span>
<span class="n">req</span><span class="p">.</span><span class="n">cpu_time</span><span class="p">,</span>
<span class="n">req</span><span class="p">.</span><span class="n">total_elapsed_time</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">dm_exec_requests</span><span class="w"> </span><span class="n">req</span>
<span class="k">CROSS</span><span class="w"> </span><span class="n">APPLY</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">dm_exec_sql_text</span><span class="p">(</span><span class="n">sql_handle</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sqltext</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="SQL cơ bản" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="p01-02-tricks-sql.html" class="btn btn-neutral float-right" title="11. Mẹo với SQL" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, Anh Hoang Duc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>